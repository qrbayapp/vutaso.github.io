<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clash of Villages - Full Strategy Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial Black', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            overflow: hidden;
            color: white;
            user-select: none;
        }

        #gameContainer {
            width: 100vw;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }

        /* Loading Screen */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.5s;
        }

        .loading-logo {
            font-size: 60px;
            margin-bottom: 20px;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .loading-bar {
            width: 300px;
            height: 30px;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            overflow: hidden;
            margin-top: 20px;
        }

        .loading-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #45b7d1);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Main Menu */
        #mainMenu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            z-index: 1000;
            border: 4px solid #ffd700;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.5);
        }

        #mainMenu h1 {
            font-size: 48px;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            margin-bottom: 10px;
        }

        #mainMenu .subtitle {
            color: #4ecdc4;
            font-size: 20px;
            margin-bottom: 30px;
        }

        .menu-btn {
            display: block;
            width: 300px;
            padding: 15px;
            margin: 15px auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .menu-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
        }

        /* Game Canvas */
        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
        }

        /* Top HUD */
        #topHUD {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 100;
        }

        .resource-display {
            display: flex;
            gap: 20px;
        }

        .resource {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0,0,0,0.5);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 18px;
            font-weight: bold;
        }

        .resource-icon {
            font-size: 24px;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .trophy-display {
            background: rgba(255, 215, 0, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            border: 2px solid #ffd700;
        }

        /* Building Menu */
        #buildingMenu {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            padding: 20px;
            border-radius: 15px;
            display: flex;
            gap: 10px;
            z-index: 100;
            border: 3px solid #667eea;
        }

        .building-btn {
            width: 80px;
            height: 100px;
            background: rgba(255,255,255,0.1);
            border: 2px solid #4ecdc4;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            position: relative;
        }

        .building-btn:hover {
            transform: scale(1.1);
            background: rgba(255,255,255,0.2);
            border-color: #ffd700;
        }

        .building-btn.selected {
            border-color: #ffd700;
            box-shadow: 0 0 20px #ffd700;
        }

        .building-icon {
            font-size: 40px;
        }

        .building-name {
            font-size: 12px;
            margin-top: 5px;
        }

        .building-cost {
            font-size: 10px;
            color: #ffd700;
        }

        /* Army Panel */
        #armyPanel {
            position: absolute;
            left: 20px;
            bottom: 20px;
            background: rgba(0,0,0,0.9);
            padding: 20px;
            border-radius: 15px;
            width: 250px;
            z-index: 100;
            border: 3px solid #ff4757;
        }

        .troop-slot {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .troop-slot:hover {
            background: rgba(255,255,255,0.2);
        }

        .troop-slot.selected {
            border: 2px solid #ffd700;
        }

        .troop-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .troop-icon {
            font-size: 30px;
        }

        .troop-count {
            background: rgba(255,71,87,0.8);
            padding: 5px 10px;
            border-radius: 10px;
            font-weight: bold;
        }

        /* Battle Stats */
        #battleStats {
            position: absolute;
            right: 20px;
            bottom: 20px;
            background: rgba(0,0,0,0.9);
            padding: 20px;
            border-radius: 15px;
            width: 200px;
            z-index: 100;
            border: 3px solid #4ecdc4;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        /* Building Info Panel */
        #buildingInfoPanel {
            position: absolute;
            top: 100px;
            right: 20px;
            background: rgba(0,0,0,0.9);
            padding: 20px;
            border-radius: 15px;
            width: 300px;
            z-index: 200;
            border: 3px solid #ffd700;
            display: none;
        }

        .info-title {
            font-size: 24px;
            color: #ffd700;
            margin-bottom: 15px;
            text-align: center;
        }

        .info-stat {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            margin: 5px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
        }

        .upgrade-btn {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            background: linear-gradient(135deg, #4ecdc4, #45b7d1);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upgrade-btn:hover {
            transform: scale(1.05);
        }

        .upgrade-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Battle Mode */
        #battleControls {
            position: absolute;
            top: 100px;
            left: 20px;
            background: rgba(0,0,0,0.9);
            padding: 20px;
            border-radius: 15px;
            z-index: 100;
            border: 3px solid #ff4757;
            display: none;
        }

        .battle-btn {
            width: 200px;
            padding: 12px;
            margin: 10px 0;
            background: linear-gradient(135deg, #ff4757, #ff6b81);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .battle-btn:hover {
            transform: scale(1.05);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            z-index: 9999;
            animation: slideDown 0.5s;
            border: 2px solid #4ecdc4;
        }

        @keyframes slideDown {
            from {
                top: -100px;
                opacity: 0;
            }
            to {
                top: 100px;
                opacity: 1;
            }
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #45b7d1);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 5000;
        }

        .modal-content {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            border: 4px solid #ffd700;
            text-align: center;
        }

        .modal-title {
            font-size: 32px;
            color: #ffd700;
            margin-bottom: 20px;
        }

        .modal-text {
            font-size: 18px;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .modal-btn {
            padding: 15px 40px;
            margin: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn:hover {
            transform: scale(1.1);
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Particle effects */
        .particle {
            position: absolute;
            pointer-events: none;
            animation: particleFloat 1s ease-out forwards;
        }

        @keyframes particleFloat {
            0% {
                opacity: 1;
                transform: translate(0, 0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(var(--tx), var(--ty)) scale(0);
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="loading-logo">üè∞</div>
        <h1 style="font-size: 48px; margin-bottom: 10px;">CLASH OF VILLAGES</h1>
        <p style="font-size: 20px;">Loading your kingdom...</p>
        <div class="loading-bar">
            <div class="loading-fill" id="loadingFill" style="width: 0%">0%</div>
        </div>
    </div>

    <!-- Main Menu -->
    <div id="mainMenu" class="hidden">
        <h1>‚öîÔ∏è CLASH OF VILLAGES ‚öîÔ∏è</h1>
        <p class="subtitle">Build, Defend, Conquer!</p>
        <button class="menu-btn" onclick="game.startGame()">üè∞ Start Game</button>
        <button class="menu-btn" onclick="game.showTutorial()">üìñ Tutorial</button>
        <button class="menu-btn" onclick="game.loadGame()">üíæ Load Game</button>
        <button class="menu-btn" onclick="game.showSettings()">‚öôÔ∏è Settings</button>
    </div>

    <div id="gameContainer">
        <!-- Game Canvas -->
        <canvas id="gameCanvas"></canvas>

        <!-- Top HUD -->
        <div id="topHUD" class="hidden">
            <div class="resource-display">
                <div class="resource">
                    <span class="resource-icon">üí∞</span>
                    <span id="goldDisplay">1000</span>
                </div>
                <div class="resource">
                    <span class="resource-icon">üíé</span>
                    <span id="elixirDisplay">500</span>
                </div>
                <div class="resource">
                    <span class="resource-icon">‚ö´</span>
                    <span id="darkElixirDisplay">0</span>
                </div>
            </div>
            <div class="player-info">
                <div class="trophy-display">
                    <span>üèÜ </span>
                    <span id="trophyDisplay">0</span>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px;">
                    <span>üëë Level <span id="levelDisplay">1</span></span>
                </div>
            </div>
        </div>

        <!-- Building Menu -->
        <div id="buildingMenu" class="hidden">
            <div class="building-btn" data-building="townhall">
                <div class="building-icon">üèõÔ∏è</div>
                <div class="building-name">Town Hall</div>
                <div class="building-cost">üí∞ 1000</div>
            </div>
            <div class="building-btn" data-building="goldmine">
                <div class="building-icon">‚õèÔ∏è</div>
                <div class="building-name">Gold Mine</div>
                <div class="building-cost">üí∞ 300</div>
            </div>
            <div class="building-btn" data-building="elixircollector">
                <div class="building-icon">üß™</div>
                <div class="building-name">Elixir</div>
                <div class="building-cost">üí∞ 400</div>
            </div>
            <div class="building-btn" data-building="barracks">
                <div class="building-icon">üèïÔ∏è</div>
                <div class="building-name">Barracks</div>
                <div class="building-cost">üí∞ 500</div>
            </div>
            <div class="building-btn" data-building="cannon">
                <div class="building-icon">üî´</div>
                <div class="building-name">Cannon</div>
                <div class="building-cost">üí∞ 600</div>
            </div>
            <div class="building-btn" data-building="archertower">
                <div class="building-icon">üóº</div>
                <div class="building-name">Archer Tower</div>
                <div class="building-cost">üí∞ 800</div>
            </div>
            <div class="building-btn" data-building="wall">
                <div class="building-icon">üß±</div>
                <div class="building-name">Wall</div>
                <div class="building-cost">üí∞ 50</div>
            </div>
            <div class="building-btn" data-building="remove">
                <div class="building-icon">‚ùå</div>
                <div class="building-name">Remove</div>
                <div class="building-cost">Free</div>
            </div>
        </div>

        <!-- Army Panel -->
        <div id="armyPanel" class="hidden">
            <h3 style="text-align: center; margin-bottom: 15px; color: #ffd700;">‚öîÔ∏è ARMY</h3>
            <div class="troop-slot" data-troop="barbarian">
                <div class="troop-info">
                    <span class="troop-icon">üó°Ô∏è</span>
                    <span>Barbarian</span>
                </div>
                <span class="troop-count" id="barbarianCount">0</span>
            </div>
            <div class="troop-slot" data-troop="archer">
                <div class="troop-info">
                    <span class="troop-icon">üèπ</span>
                    <span>Archer</span>
                </div>
                <span class="troop-count" id="archerCount">0</span>
            </div>
            <div class="troop-slot" data-troop="giant">
                <div class="troop-info">
                    <span class="troop-icon">üßî</span>
                    <span>Giant</span>
                </div>
                <span class="troop-count" id="giantCount">0</span>
            </div>
            <div class="troop-slot" data-troop="wizard">
                <div class="troop-info">
                    <span class="troop-icon">üßô</span>
                    <span>Wizard</span>
                </div>
                <span class="troop-count" id="wizardCount">0</span>
            </div>
        </div>

        <!-- Battle Stats -->
        <div id="battleStats" class="hidden">
            <h3 style="text-align: center; margin-bottom: 15px; color: #ffd700;">üìä STATS</h3>
            <div class="stat-item">
                <span>Destruction:</span>
                <span id="destructionPercent">0%</span>
            </div>
            <div class="stat-item">
                <span>Stars:</span>
                <span id="starsEarned">0 ‚≠ê</span>
            </div>
            <div class="stat-item">
                <span>Gold Loot:</span>
                <span id="goldLooted">0 üí∞</span>
            </div>
            <div class="stat-item">
                <span>Elixir Loot:</span>
                <span id="elixirLooted">0 üíé</span>
            </div>
        </div>

        <!-- Building Info Panel -->
        <div id="buildingInfoPanel">
            <h3 class="info-title" id="buildingInfoTitle">Building Info</h3>
            <div class="info-stat">
                <span>Level:</span>
                <span id="buildingLevel">1</span>
            </div>
            <div class="info-stat">
                <span>HP:</span>
                <span id="buildingHP">100/100</span>
            </div>
            <div class="info-stat">
                <span>Production:</span>
                <span id="buildingProduction">0/hr</span>
            </div>
            <button class="upgrade-btn" id="upgradeBtn" onclick="game.upgradeSelectedBuilding()">
                ‚¨ÜÔ∏è Upgrade (üí∞ 500)
            </button>
            <button class="upgrade-btn" style="background: linear-gradient(135deg, #ff4757, #ff6b81); margin-top: 10px;" onclick="game.closeInfoPanel()">
                Close
            </button>
        </div>

        <!-- Battle Controls -->
        <div id="battleControls">
            <h3 style="text-align: center; margin-bottom: 15px; color: #ffd700;">‚öîÔ∏è BATTLE</h3>
            <button class="battle-btn" onclick="game.toggleBattleMode()">üè† Return to Village</button>
            <button class="battle-btn" onclick="game.findMatch()">üîç Find Match</button>
            <button class="battle-btn" onclick="game.surrenderBattle()">üè≥Ô∏è Surrender</button>
        </div>
    </div>

    <!-- Victory Modal -->
    <div id="victoryModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">‚≠ê VICTORY! ‚≠ê</h2>
            <p class="modal-text" id="victoryText">You earned 3 stars!</p>
            <div style="margin: 20px 0;">
                <div class="info-stat">
                    <span>Destruction:</span>
                    <span id="finalDestruction">100%</span>
                </div>
                <div class="info-stat">
                    <span>Gold Looted:</span>
                    <span id="finalGoldLooted">500 üí∞</span>
                </div>
                <div class="info-stat">
                    <span>Elixir Looted:</span>
                    <span id="finalElixirLooted">300 üíé</span>
                </div>
                <div class="info-stat">
                    <span>Trophies:</span>
                    <span id="finalTrophies">+30 üèÜ</span>
                </div>
            </div>
            <button class="modal-btn" onclick="game.closeVictoryModal()">Continue</button>
        </div>
    </div>

    <script>
        // ==================== CLASH OF VILLAGES GAME ENGINE ====================
        
        class ClashOfVillages {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                
                this.initializeGame();
                this.setupEventListeners();
                this.simulateLoading();
            }
            
            initializeGame() {
                // Game state
                this.gameMode = 'menu'; // menu, build, battle
                this.isPaused = false;
                
                // Player resources
                this.resources = {
                    gold: 1000,
                    elixir: 500,
                    darkElixir: 0,
                    trophies: 0,
                    level: 1,
                    exp: 0,
                    maxExp: 100
                };
                
                // Grid system
                this.gridSize = 40;
                this.gridWidth = Math.floor(this.canvas.width / this.gridSize);
                this.gridHeight = Math.floor(this.canvas.height / this.gridSize);
                this.grid = [];
                
                // Initialize empty grid
                for (let y = 0; y < this.gridHeight; y++) {
                    this.grid[y] = [];
                    for (let x = 0; x < this.gridWidth; x++) {
                        this.grid[y][x] = null;
                    }
                }
                
                // Buildings
                this.buildings = [];
                this.selectedBuilding = null;
                this.selectedBuildingType = null;
                this.placementMode = false;
                
                // Troops
                this.troops = {
                    barbarian: { count: 10, maxCount: 50, hp: 100, damage: 20, speed: 2, icon: 'üó°Ô∏è', cost: 50 },
                    archer: { count: 10, maxCount: 40, hp: 60, damage: 15, speed: 2.5, icon: 'üèπ', cost: 80 },
                    giant: { count: 5, maxCount: 20, hp: 500, damage: 50, speed: 1, icon: 'üßî', cost: 200 },
                    wizard: { count: 3, maxCount: 15, hp: 120, damage: 100, speed: 1.5, icon: 'üßô', cost: 300 }
                };
                
                this.deployedTroops = [];
                this.selectedTroopType = null;
                
                // Battle
                this.battleMode = false;
                this.enemyVillage = null;
                this.battleStats = {
                    destruction: 0,
                    stars: 0,
                    goldLooted: 0,
                    elixirLooted: 0
                };
                
                // Camera
                this.camera = {
                    x: 0,
                    y: 0,
                    zoom: 1,
                    targetX: 0,
                    targetY: 0
                };
                
                // Mouse
                this.mouse = {
                    x: 0,
                    y: 0,
                    gridX: 0,
                    gridY: 0,
                    down: false
                };
                
                // Animation
                this.lastTime = 0;
                this.animationId = null;
                
                // Building definitions
                this.buildingTypes = {
                    townhall: {
                        name: 'Town Hall',
                        icon: 'üèõÔ∏è',
                        cost: { gold: 1000, elixir: 0 },
                        size: 4,
                        hp: 2000,
                        maxHp: 2000,
                        production: 0,
                        level: 1,
                        maxLevel: 10
                    },
                    goldmine: {
                        name: 'Gold Mine',
                        icon: '‚õèÔ∏è',
                        cost: { gold: 300, elixir: 0 },
                        size: 3,
                        hp: 500,
                        maxHp: 500,
                        production: 100,
                        level: 1,
                        maxLevel: 10,
                        storage: 0,
                        maxStorage: 1000
                    },
                    elixircollector: {
                        name: 'Elixir Collector',
                        icon: 'üß™',
                        cost: { gold: 400, elixir: 0 },
                        size: 3,
                        hp: 500,
                        maxHp: 500,
                        production: 80,
                        level: 1,
                        maxLevel: 10,
                        storage: 0,
                        maxStorage: 800
                    },
                    barracks: {
                        name: 'Barracks',
                        icon: 'üèïÔ∏è',
                        cost: { gold: 500, elixir: 100 },
                        size: 3,
                        hp: 800,
                        maxHp: 800,
                        production: 0,
                        level: 1,
                        maxLevel: 10,
                        trainSpeed: 1
                    },
                    cannon: {
                        name: 'Cannon',
                        icon: 'üî´',
                        cost: { gold: 600, elixir: 0 },
                        size: 2,
                        hp: 700,
                        maxHp: 700,
                        damage: 30,
                        range: 150,
                        attackSpeed: 1.5,
                        level: 1,
                        maxLevel: 10,
                        isDefense: true,
                        target: null,
                        cooldown: 0
                    },
                    archertower: {
                        name: 'Archer Tower',
                        icon: 'üóº',
                        cost: { gold: 800, elixir: 0 },
                        size: 2,
                        hp: 600,
                        maxHp: 600,
                        damage: 25,
                        range: 200,
                        attackSpeed: 1,
                        level: 1,
                        maxLevel: 10,
                        isDefense: true,
                        target: null,
                        cooldown: 0
                    },
                    wall: {
                        name: 'Wall',
                        icon: 'üß±',
                        cost: { gold: 50, elixir: 0 },
                        size: 1,
                        hp: 300,
                        maxHp: 300,
                        level: 1,
                        maxLevel: 10
                    }
                };
            }
            
            setupEventListeners() {
                // Mouse events
                this.canvas.addEventListener('mousemove', (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    this.mouse.x = e.clientX - rect.left;
                    this.mouse.y = e.clientY - rect.top;
                    this.mouse.gridX = Math.floor((this.mouse.x + this.camera.x) / this.gridSize);
                    this.mouse.gridY = Math.floor((this.mouse.y + this.camera.y) / this.gridSize);
                });
                
                this.canvas.addEventListener('mousedown', (e) => {
                    this.mouse.down = true;
                    this.handleClick();
                });
                
                this.canvas.addEventListener('mouseup', () => {
                    this.mouse.down = false;
                });
                
                // Touch events for mobile
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const rect = this.canvas.getBoundingClientRect();
                    const touch = e.touches[0];
                    this.mouse.x = touch.clientX - rect.left;
                    this.mouse.y = touch.clientY - rect.top;
                    this.mouse.gridX = Math.floor((this.mouse.x + this.camera.x) / this.gridSize);
                    this.mouse.gridY = Math.floor((this.mouse.y + this.camera.y) / this.gridSize);
                    this.handleClick();
                });
                
                // Building menu
                document.querySelectorAll('.building-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const buildingType = btn.dataset.building;
                        if (buildingType === 'remove') {
                            this.selectedBuildingType = 'remove';
                            this.placementMode = true;
                        } else if (buildingType) {
                            this.selectBuilding(buildingType);
                        }
                        
                        document.querySelectorAll('.building-btn').forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                    });
                });
                
                // Troop selection
                document.querySelectorAll('.troop-slot').forEach(slot => {
                    slot.addEventListener('click', () => {
                        const troopType = slot.dataset.troop;
                        if (this.battleMode && troopType) {
                            this.selectTroop(troopType);
                            document.querySelectorAll('.troop-slot').forEach(s => s.classList.remove('selected'));
                            slot.classList.add('selected');
                        }
                    });
                });
                
                // Window resize
                window.addEventListener('resize', () => {
                    this.canvas.width = window.innerWidth;
                    this.canvas.height = window.innerHeight;
                    this.gridWidth = Math.floor(this.canvas.width / this.gridSize);
                    this.gridHeight = Math.floor(this.canvas.height / this.gridSize);
                });
            }
            
            simulateLoading() {
                let progress = 0;
                const interval = setInterval(() => {
                    progress += Math.random() * 20;
                    if (progress >= 100) {
                        progress = 100;
                        clearInterval(interval);
                        setTimeout(() => {
                            document.getElementById('loadingScreen').style.opacity = '0';
                            setTimeout(() => {
                                document.getElementById('loadingScreen').classList.add('hidden');
                                document.getElementById('mainMenu').classList.remove('hidden');
                            }, 500);
                        }, 500);
                    }
                    document.getElementById('loadingFill').style.width = progress + '%';
                    document.getElementById('loadingFill').textContent = Math.floor(progress) + '%';
                }, 200);
            }
            
            startGame() {
                document.getElementById('mainMenu').classList.add('hidden');
                document.getElementById('topHUD').classList.remove('hidden');
                document.getElementById('buildingMenu').classList.remove('hidden');
                document.getElementById('armyPanel').classList.remove('hidden');
                
                this.gameMode = 'build';
                this.updateResourceDisplay();
                
                // Add initial buildings
                this.placeInitialBuildings();
                
                // Start game loop
                this.gameLoop(0);
                
                this.showNotification('üè∞ Welcome to your village!');
            }
            
            placeInitialBuildings() {
                // Place Town Hall
                this.addBuilding('townhall', 10, 10);
                
                // Place some initial buildings
                this.addBuilding('goldmine', 15, 10);
                this.addBuilding('elixircollector', 10, 15);
                this.addBuilding('barracks', 15, 15);
            }
            
            gameLoop(timestamp) {
                const deltaTime = timestamp - this.lastTime;
                this.lastTime = timestamp;
                
                if (!this.isPaused) {
                    this.update(deltaTime);
                    this.render();
                }
                
                this.animationId = requestAnimationFrame((t) => this.gameLoop(t));
            }
            
            update(dt) {
                // Update resource production
                this.updateProduction(dt);
                
                // Update troops in battle
                if (this.battleMode) {
                    this.updateBattle(dt);
                }
                
                // Update defenses
                this.updateDefenses(dt);
            }
            
            updateProduction(dt) {
                const productionRate = dt / 1000 / 3600; // per hour to per millisecond
                
                this.buildings.forEach(building => {
                    if (building.type === 'goldmine' && building.storage < building.maxStorage) {
                        building.storage += building.production * productionRate;
                        if (building.storage >= building.maxStorage) {
                            building.storage = building.maxStorage;
                        }
                    } else if (building.type === 'elixircollector' && building.storage < building.maxStorage) {
                        building.storage += building.production * productionRate;
                        if (building.storage >= building.maxStorage) {
                            building.storage = building.maxStorage;
                        }
                    }
                });
            }
            
            updateBattle(dt) {
                // Update deployed troops
                this.deployedTroops.forEach((troop, index) => {
                    if (troop.hp <= 0) {
                        this.deployedTroops.splice(index, 1);
                        return;
                    }
                    
                    // Find target
                    if (!troop.target || troop.target.hp <= 0) {
                        troop.target = this.findNearestBuilding(troop);
                    }
                    
                    if (troop.target) {
                        // Move towards target
                        const dx = troop.target.x - troop.x;
                        const dy = troop.target.y - troop.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        
                        if (dist > 30) {
                            troop.x += (dx / dist) * troop.speed;
                            troop.y += (dy / dist) * troop.speed;
                        } else {
                            // Attack
                            if (troop.cooldown <= 0) {
                                troop.target.hp -= troop.damage;
                                troop.cooldown = 1000;
                                this.createHitEffect(troop.target.x, troop.target.y);
                                
                                if (troop.target.hp <= 0) {
                                    this.onBuildingDestroyed(troop.target);
                                }
                            }
                        }
                    }
                    
                    if (troop.cooldown > 0) {
                        troop.cooldown -= dt;
                    }
                });
                
                // Check battle end conditions
                if (this.deployedTroops.length === 0 && this.getTotalTroopCount() === 0) {
                    this.endBattle();
                }
            }
            
            updateDefenses(dt) {
                this.buildings.forEach(building => {
                    if (building.isDefense && this.battleMode) {
                        // Find target
                        if (!building.target || building.target.hp <= 0) {
                            building.target = this.findNearestTroop(building);
                        }
                        
                        if (building.target) {
                            const dx = building.target.x - building.x;
                            const dy = building.target.y - building.y;
                            const dist = Math.sqrt(dx * dx + dy * dy);
                            
                            if (dist <= building.range) {
                                if (building.cooldown <= 0) {
                                    building.target.hp -= building.damage;
                                    building.cooldown = building.attackSpeed * 1000;
                                    this.createProjectile(building, building.target);
                                    
                                    if (building.target.hp <= 0) {
                                        building.target = null;
                                    }
                                }
                            } else {
                                building.target = null;
                            }
                        }
                        
                        if (building.cooldown > 0) {
                            building.cooldown -= dt;
                        }
                    }
                });
            }
            
            render() {
                // Clear canvas
                this.ctx.fillStyle = '#2d5016';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Draw grid
                this.drawGrid();
                
                // Draw buildings
                this.buildings.forEach(building => {
                    this.drawBuilding(building);
                });
                
                // Draw troops
                this.deployedTroops.forEach(troop => {
                    this.drawTroop(troop);
                });
                
                // Draw placement preview
                if (this.placementMode && this.selectedBuildingType) {
                    this.drawPlacementPreview();
                }
            }
            
            drawGrid() {
                this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                this.ctx.lineWidth = 1;
                
                for (let x = 0; x <= this.gridWidth; x++) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(x * this.gridSize - this.camera.x, 0);
                    this.ctx.lineTo(x * this.gridSize - this.camera.x, this.canvas.height);
                    this.ctx.stroke();
                }
                
                for (let y = 0; y <= this.gridHeight; y++) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, y * this.gridSize - this.camera.y);
                    this.ctx.lineTo(this.canvas.width, y * this.gridSize - this.camera.y);
                    this.ctx.stroke();
                }
            }
            
            drawBuilding(building) {
                const x = building.gridX * this.gridSize - this.camera.x;
                const y = building.gridY * this.gridSize - this.camera.y;
                const size = building.size * this.gridSize;
                
                // Building background
                this.ctx.fillStyle = building === this.selectedBuilding ? 
                    'rgba(255, 215, 0, 0.3)' : 'rgba(139, 69, 19, 0.8)';
                this.ctx.fillRect(x, y, size, size);
                
                // Building border
                this.ctx.strokeStyle = building === this.selectedBuilding ? '#ffd700' : '#8B4513';
                this.ctx.lineWidth = 2;
                this.ctx.strokeRect(x, y, size, size);
                
                // Building icon
                this.ctx.font = `${size * 0.6}px Arial`;
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                this.ctx.fillText(building.icon, x + size / 2, y + size / 2);
                
                // HP bar
                const hpPercent = building.hp / building.maxHp;
                const barWidth = size - 10;
                const barHeight = 6;
                
                this.ctx.fillStyle = '#ff0000';
                this.ctx.fillRect(x + 5, y + size - 15, barWidth, barHeight);
                
                this.ctx.fillStyle = '#00ff00';
                this.ctx.fillRect(x + 5, y + size - 15, barWidth * hpPercent, barHeight);
                
                // Level
                this.ctx.font = '12px Arial';
                this.ctx.fillStyle = '#ffd700';
                this.ctx.fillText(`Lv ${building.level}`, x + size / 2, y + size + 15);
                
                // Storage indicator (for resource buildings)
                if (building.storage !== undefined && building.maxStorage) {
                    const storagePercent = (building.storage / building.maxStorage) * 100;
                    if (storagePercent >= 90) {
                        this.ctx.font = '20px Arial';
                        this.ctx.fillText('üí∞', x + size - 15, y + 15);
                    }
                }
            }
            
            drawTroop(troop) {
                const x = troop.x - this.camera.x;
                const y = troop.y - this.camera.y;
                
                // Troop circle
                this.ctx.fillStyle = 'rgba(255, 0, 0, 0.3)';
                this.ctx.beginPath();
                this.ctx.arc(x, y, 15, 0, Math.PI * 2);
                this.ctx.fill();
                
                // Troop icon
                this.ctx.font = '20px Arial';
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                this.ctx.fillText(troop.icon, x, y);
                
                // HP bar
                const hpPercent = troop.hp / troop.maxHp;
                const barWidth = 30;
                const barHeight = 4;
                
                this.ctx.fillStyle = '#ff0000';
                this.ctx.fillRect(x - barWidth / 2, y - 20, barWidth, barHeight);
                
                this.ctx.fillStyle = '#00ff00';
                this.ctx.fillRect(x - barWidth / 2, y - 20, barWidth * hpPercent, barHeight);
            }
            
            drawPlacementPreview() {
                if (this.selectedBuildingType === 'remove') {
                    return;
                }
                
                const building = this.buildingTypes[this.selectedBuildingType];
                const x = this.mouse.gridX * this.gridSize - this.camera.x;
                const y = this.mouse.gridY * this.gridSize - this.camera.y;
                const size = building.size * this.gridSize;
                
                const canPlace = this.canPlaceBuilding(this.mouse.gridX, this.mouse.gridY, building.size);
                
                this.ctx.fillStyle = canPlace ? 'rgba(0, 255, 0, 0.3)' : 'rgba(255, 0, 0, 0.3)';
                this.ctx.fillRect(x, y, size, size);
                
                this.ctx.strokeStyle = canPlace ? '#00ff00' : '#ff0000';
                this.ctx.lineWidth = 2;
                this.ctx.strokeRect(x, y, size, size);
                
                this.ctx.font = `${size * 0.6}px Arial`;
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                this.ctx.fillText(building.icon, x + size / 2, y + size / 2);
            }
            
            handleClick() {
                if (this.placementMode && this.selectedBuildingType) {
                    if (this.selectedBuildingType === 'remove') {
                        this.removeBuilding(this.mouse.gridX, this.mouse.gridY);
                    } else {
                        this.placeBuilding();
                    }
                } else if (this.battleMode && this.selectedTroopType) {
                    this.deployTroop();
                } else {
                    this.selectBuildingAt(this.mouse.gridX, this.mouse.gridY);
                }
            }
            
            selectBuilding(type) {
                this.selectedBuildingType = type;
                this.placementMode = true;
            }
            
            canPlaceBuilding(gridX, gridY, size) {
                if (gridX < 0 || gridY < 0 || gridX + size > this.gridWidth || gridY + size > this.gridHeight) {
                    return false;
                }
                
                for (let y = gridY; y < gridY + size; y++) {
                    for (let x = gridX; x < gridX + size; x++) {
                        if (this.grid[y] && this.grid[y][x] !== null) {
                            return false;
                        }
                    }
                }
                
                return true;
            }
            
            placeBuilding() {
                if (!this.selectedBuildingType) return;
                
                const buildingDef = this.buildingTypes[this.selectedBuildingType];
                
                if (!this.canPlaceBuilding(this.mouse.gridX, this.mouse.gridY, buildingDef.size)) {
                    this.showNotification('‚ùå Cannot place building here!');
                    return;
                }
                
                if (this.resources.gold < buildingDef.cost.gold || 
                    this.resources.elixir < buildingDef.cost.elixir) {
                    this.showNotification('‚ùå Not enough resources!');
                    return;
                }
                
                this.resources.gold -= buildingDef.cost.gold;
                this.resources.elixir -= buildingDef.cost.elixir;
                
                this.addBuilding(this.selectedBuildingType, this.mouse.gridX, this.mouse.gridY);
                
                this.updateResourceDisplay();
                this.showNotification(`‚úÖ ${buildingDef.name} placed!`);
            }
            
            addBuilding(type, gridX, gridY) {
                const buildingDef = { ...this.buildingTypes[type] };
                
                const building = {
                    type: type,
                    gridX: gridX,
                    gridY: gridY,
                    x: gridX * this.gridSize + (buildingDef.size * this.gridSize) / 2,
                    y: gridY * this.gridSize + (buildingDef.size * this.gridSize) / 2,
                    ...buildingDef,
                    storage: buildingDef.storage || 0
                };
                
                // Mark grid cells as occupied
                for (let y = gridY; y < gridY + buildingDef.size; y++) {
                    for (let x = gridX; x < gridX + buildingDef.size; x++) {
                        if (this.grid[y]) {
                            this.grid[y][x] = building;
                        }
                    }
                }
                
                this.buildings.push(building);
            }
            
            removeBuilding(gridX, gridY) {
                const building = this.grid[gridY] && this.grid[gridY][gridX];
                
                if (!building) {
                    this.showNotification('‚ùå No building to remove!');
                    return;
                }
                
                // Refund resources
                const buildingDef = this.buildingTypes[building.type];
                this.resources.gold += Math.floor(buildingDef.cost.gold * 0.5);
                this.resources.elixir += Math.floor(buildingDef.cost.elixir * 0.5);
                
                // Clear grid
                for (let y = building.gridY; y < building.gridY + building.size; y++) {
                    for (let x = building.gridX; x < building.gridX + building.size; x++) {
                        if (this.grid[y]) {
                            this.grid[y][x] = null;
                        }
                    }
                }
                
                // Remove from buildings array
                const index = this.buildings.indexOf(building);
                if (index > -1) {
                    this.buildings.splice(index, 1);
                }
                
                this.updateResourceDisplay();
                this.showNotification(`‚úÖ Building removed!`);
            }
            
            selectBuildingAt(gridX, gridY) {
                const building = this.grid[gridY] && this.grid[gridY][gridX];
                
                if (building) {
                    this.selectedBuilding = building;
                    this.showBuildingInfo(building);
                } else {
                    this.selectedBuilding = null;
                    this.closeInfoPanel();
                }
            }
            
            showBuildingInfo(building) {
                const panel = document.getElementById('buildingInfoPanel');
                panel.style.display = 'block';
                
                document.getElementById('buildingInfoTitle').textContent = building.name;
                document.getElementById('buildingLevel').textContent = building.level;
                document.getElementById('buildingHP').textContent = `${Math.floor(building.hp)}/${building.maxHp}`;
                
                if (building.production) {
                    document.getElementById('buildingProduction').textContent = `${building.production}/hr`;
                } else if (building.damage) {
                    document.getElementById('buildingProduction').textContent = `${building.damage} DMG`;
                } else {
                    document.getElementById('buildingProduction').textContent = 'N/A';
                }
                
                const upgradeCost = building.level * 500;
                document.getElementById('upgradeBtn').textContent = `‚¨ÜÔ∏è Upgrade (üí∞ ${upgradeCost})`;
                document.getElementById('upgradeBtn').disabled = building.level >= building.maxLevel;
                
                // Collect resources if storage building
                if (building.storage && building.storage > 0) {
                    const collectBtn = document.getElementById('upgradeBtn');
                    collectBtn.textContent = `üí∞ Collect (${Math.floor(building.storage)})`;
                    collectBtn.disabled = false;
                }
            }
            
            upgradeSelectedBuilding() {
                if (!this.selectedBuilding) return;
                
                // Check if it's a collect action
                if (this.selectedBuilding.storage && this.selectedBuilding.storage > 0) {
                    if (this.selectedBuilding.type === 'goldmine') {
                        this.resources.gold += Math.floor(this.selectedBuilding.storage);
                    } else if (this.selectedBuilding.type === 'elixircollector') {
                        this.resources.elixir += Math.floor(this.selectedBuilding.storage);
                    }
                    this.selectedBuilding.storage = 0;
                    this.updateResourceDisplay();
                    this.showNotification('‚úÖ Resources collected!');
                    this.closeInfoPanel();
                    return;
                }
                
                if (this.selectedBuilding.level >= this.selectedBuilding.maxLevel) {
                    this.showNotification('‚ùå Max level reached!');
                    return;
                }
                
                const upgradeCost = this.selectedBuilding.level * 500;
                
                if (this.resources.gold < upgradeCost) {
                    this.showNotification('‚ùå Not enough gold!');
                    return;
                }
                
                this.resources.gold -= upgradeCost;
                this.selectedBuilding.level++;
                this.selectedBuilding.hp = this.selectedBuilding.maxHp * this.selectedBuilding.level;
                this.selectedBuilding.maxHp = this.selectedBuilding.maxHp * this.selectedBuilding.level;
                
                if (this.selectedBuilding.production) {
                    this.selectedBuilding.production *= 1.2;
                    this.selectedBuilding.maxStorage *= 1.3;
                }
                
                if (this.selectedBuilding.damage) {
                    this.selectedBuilding.damage *= 1.2;
                    this.selectedBuilding.range *= 1.1;
                }
                
                this.updateResourceDisplay();
                this.showNotification(`‚úÖ Upgraded to level ${this.selectedBuilding.level}!`);
                this.showBuildingInfo(this.selectedBuilding);
            }
            
            closeInfoPanel() {
                document.getElementById('buildingInfoPanel').style.display = 'none';
            }
            
            // Battle functions
            toggleBattleMode() {
                this.battleMode = !this.battleMode;
                
                if (this.battleMode) {
                    document.getElementById('buildingMenu').classList.add('hidden');
                    document.getElementById('battleControls').style.display = 'block';
                    document.getElementById('battleStats').classList.remove('hidden');
                    this.showNotification('‚öîÔ∏è Battle Mode Activated!');
                } else {
                    document.getElementById('buildingMenu').classList.remove('hidden');
                    document.getElementById('battleControls').style.display = 'none';
                    document.getElementById('battleStats').classList.add('hidden');
                    this.deployedTroops = [];
                    this.restoreBuildings();
                    this.showNotification('üè† Returned to Village');
                }
            }
            
            findMatch() {
                this.generateEnemyVillage();
                this.showNotification('üéØ Enemy found! Deploy your troops!');
            }
            
            generateEnemyVillage() {
                // Clear current buildings
                this.buildings = [];
                this.grid = [];
                
                for (let y = 0; y < this.gridHeight; y++) {
                    this.grid[y] = [];
                    for (let x = 0; x < this.gridWidth; x++) {
                        this.grid[y][x] = null;
                    }
                }
                
                // Generate random enemy base
                const centerX = Math.floor(this.gridWidth / 2);
                const centerY = Math.floor(this.gridHeight / 2);
                
                this.addBuilding('townhall', centerX - 2, centerY - 2);
                this.addBuilding('cannon', centerX - 8, centerY - 2);
                this.addBuilding('cannon', centerX + 4, centerY - 2);
                this.addBuilding('archertower', centerX - 2, centerY - 8);
                this.addBuilding('archertower', centerX - 2, centerY + 4);
                this.addBuilding('goldmine', centerX - 6, centerY - 6);
                this.addBuilding('elixircollector', centerX + 2, centerY - 6);
                
                // Add walls
                for (let i = -10; i <= 10; i++) {
                    if (Math.abs(i) > 4) {
                        this.addBuilding('wall', centerX + i, centerY - 10);
                        this.addBuilding('wall', centerX + i, centerY + 6);
                        if (Math.abs(i) === 10) {
                            for (let j = -9; j <= 5; j++) {
                                this.addBuilding('wall', centerX + i, centerY + j);
                            }
                        }
                    }
                }
                
                this.battleStats = {
                    destruction: 0,
                    stars: 0,
                    goldLooted: 0,
                    elixirLooted: 0,
                    totalBuildings: this.buildings.length,
                    destroyedBuildings: 0
                };
            }
            
            selectTroop(type) {
                if (this.troops[type].count > 0) {
                    this.selectedTroopType = type;
                }
            }
            
            deployTroop() {
                if (!this.selectedTroopType || this.troops[this.selectedTroopType].count <= 0) {
                    this.showNotification('‚ùå No troops available!');
                    return;
                }
                
                const troopDef = this.troops[this.selectedTroopType];
                
                const troop = {
                    type: this.selectedTroopType,
                    x: this.mouse.x + this.camera.x,
                    y: this.mouse.y + this.camera.y,
                    hp: troopDef.hp,
                    maxHp: troopDef.hp,
                    damage: troopDef.damage,
                    speed: troopDef.speed,
                    icon: troopDef.icon,
                    target: null,
                    cooldown: 0
                };
                
                this.deployedTroops.push(troop);
                this.troops[this.selectedTroopType].count--;
                
                this.updateTroopDisplay();
            }
            
            findNearestBuilding(troop) {
                let nearest = null;
                let minDist = Infinity;
                
                this.buildings.forEach(building => {
                    if (building.hp > 0) {
                        const dx = building.x - troop.x;
                        const dy = building.y - troop.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        
                        if (dist < minDist) {
                            minDist = dist;
                            nearest = building;
                        }
                    }
                });
                
                return nearest;
            }
            
            findNearestTroop(building) {
                let nearest = null;
                let minDist = Infinity;
                
                this.deployedTroops.forEach(troop => {
                    if (troop.hp > 0) {
                        const dx = troop.x - building.x;
                        const dy = troop.y - building.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        
                        if (dist < minDist && dist <= building.range) {
                            minDist = dist;
                            nearest = troop;
                        }
                    }
                });
                
                return nearest;
            }
            
            onBuildingDestroyed(building) {
                this.battleStats.destroyedBuildings++;
                this.battleStats.destruction = (this.battleStats.destroyedBuildings / this.battleStats.totalBuildings) * 100;
                
                if (building.type === 'townhall') {
                    this.battleStats.stars = 3;
                    this.endBattle();
                } else if (this.battleStats.destruction >= 50 && this.battleStats.stars < 1) {
                    this.battleStats.stars = 1;
                } else if (this.battleStats.destruction >= 100 && this.battleStats.stars < 2) {
                    this.battleStats.stars = 2;
                }
                
                // Loot
                if (building.type === 'goldmine') {
                    this.battleStats.goldLooted += 200;
                } else if (building.type === 'elixircollector') {
                    this.battleStats.elixirLooted += 150;
                }
                
                this.updateBattleStats();
                this.createExplosion(building.x, building.y);
            }
            
            endBattle() {
                this.resources.gold += this.battleStats.goldLooted;
                this.resources.elixir += this.battleStats.elixirLooted;
                this.resources.trophies += this.battleStats.stars * 10;
                
                this.updateResourceDisplay();
                this.showVictoryScreen();
            }
            
            showVictoryScreen() {
                document.getElementById('finalDestruction').textContent = Math.floor(this.battleStats.destruction) + '%';
                document.getElementById('finalGoldLooted').textContent = this.battleStats.goldLooted + ' üí∞';
                document.getElementById('finalElixirLooted').textContent = this.battleStats.elixirLooted + ' üíé';
                document.getElementById('finalTrophies').textContent = '+' + (this.battleStats.stars * 10) + ' üèÜ';
                document.getElementById('victoryText').textContent = `You earned ${this.battleStats.stars} stars!`;
                
                document.getElementById('victoryModal').style.display = 'flex';
            }
            
            closeVictoryModal() {
                document.getElementById('victoryModal').style.display = 'none';
                this.toggleBattleMode();
            }
            
            surrenderBattle() {
                if (confirm('Are you sure you want to surrender?')) {
                    this.toggleBattleMode();
                }
            }
            
            restoreBuildings() {
                this.buildings.forEach(building => {
                    building.hp = building.maxHp;
                });
            }
            
            getTotalTroopCount() {
                return Object.values(this.troops).reduce((sum, troop) => sum + troop.count, 0);
            }
            
            // UI Updates
            updateResourceDisplay() {
                document.getElementById('goldDisplay').textContent = this.resources.gold;
                document.getElementById('elixirDisplay').textContent = this.resources.elixir;
                document.getElementById('darkElixirDisplay').textContent = this.resources.darkElixir;
                document.getElementById('trophyDisplay').textContent = this.resources.trophies;
                document.getElementById('levelDisplay').textContent = this.resources.level;
            }
            
            updateTroopDisplay() {
                document.getElementById('barbarianCount').textContent = this.troops.barbarian.count;
                document.getElementById('archerCount').textContent = this.troops.archer.count;
                document.getElementById('giantCount').textContent = this.troops.giant.count;
                document.getElementById('wizardCount').textContent = this.troops.wizard.count;
            }
            
            updateBattleStats() {
                document.getElementById('destructionPercent').textContent = Math.floor(this.battleStats.destruction) + '%';
                document.getElementById('starsEarned').textContent = this.battleStats.stars + ' ‚≠ê';
                document.getElementById('goldLooted').textContent = this.battleStats.goldLooted + ' üí∞';
                document.getElementById('elixirLooted').textContent = this.battleStats.elixirLooted + ' üíé';
            }
            
            showNotification(message) {
                const div = document.createElement('div');
                div.className = 'notification';
                div.textContent = message;
                document.body.appendChild(div);
                
                setTimeout(() => div.remove(), 3000);
            }
            
            createHitEffect(x, y) {
                for (let i = 0; i < 5; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.textContent = 'üí•';
                    particle.style.left = (x - this.camera.x) + 'px';
                    particle.style.top = (y - this.camera.y) + 'px';
                    particle.style.setProperty('--tx', (Math.random() - 0.5) * 50 + 'px');
                    particle.style.setProperty('--ty', (Math.random() - 0.5) * 50 + 'px');
                    document.body.appendChild(particle);
                    
                    setTimeout(() => particle.remove(), 1000);
                }
            }
            
            createExplosion(x, y) {
                for (let i = 0; i < 15; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.textContent = ['üí•', 'üî•', 'üí®'][Math.floor(Math.random() * 3)];
                    particle.style.left = (x - this.camera.x) + 'px';
                    particle.style.top = (y - this.camera.y) + 'px';
                    particle.style.setProperty('--tx', (Math.random() - 0.5) * 100 + 'px');
                    particle.style.setProperty('--ty', (Math.random() - 0.5) * 100 + 'px');
                    document.body.appendChild(particle);
                    
                    setTimeout(() => particle.remove(), 1000);
                }
            }
            
            createProjectile(from, to) {
                // Visual projectile effect
                this.createHitEffect(to.x, to.y);
            }
            
            // Menu functions
            showTutorial() {
                alert(`üéÆ TUTORIAL

üèóÔ∏è BUILD MODE:
- Click buildings in bottom menu to select
- Click on grid to place buildings
- Click buildings to view info & upgrade
- Collect resources from mines regularly

‚öîÔ∏è BATTLE MODE:
- Click "Battle" to find opponents
- Select troops from left panel
- Click on map to deploy troops
- Destroy 50% for 1 star, 100% for 2 stars, Town Hall for 3 stars

üí° TIPS:
- Upgrade buildings to get stronger
- Train troops in Barracks
- Place defenses strategically
- Protect your Town Hall!`);
            }
            
            loadGame() {
                this.showNotification('üíæ No saved game found');
            }
            
            showSettings() {
                alert('‚öôÔ∏è SETTINGS\n\nMusic: ON\nSound: ON\nGraphics: HIGH');
            }
        }
        
        // Initialize game
        const game = new ClashOfVillages();
        window.game = game;
        
        console.log('%c‚öîÔ∏è CLASH OF VILLAGES LOADED! ‚öîÔ∏è', 'color: #ffd700; font-size: 24px; font-weight: bold;');
    </script>
</body>
</html>
