<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Racing Game - Ultimate Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial Black', Arial, sans-serif;
            background: #000;
            overflow: hidden;
            color: white;
        }

        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #87CEEB 0%, #E0F6FF 50%, #2F4F4F 100%);
        }

        /* HUD */
        #hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        /* Speedometer */
        #speedometer {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.7) 100%);
            border-radius: 50%;
            border: 5px solid #FFD700;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        }

        #speedValue {
            font-size: 64px;
            font-weight: bold;
            color: #00FF00;
            text-shadow: 0 0 20px #00FF00;
        }

        #speedLabel {
            font-size: 20px;
            color: #FFD700;
            margin-top: 5px;
        }

        .speed-bar {
            position: absolute;
            bottom: 40px;
            width: 80%;
            left: 50%;
            transform: translateX(-50%);
        }

        .speed-track {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            overflow: hidden;
        }

        .speed-fill {
            height: 100%;
            background: linear-gradient(90deg, #00FF00, #FFFF00, #FF0000);
            transition: width 0.1s;
            box-shadow: 0 0 10px currentColor;
        }

        /* Position & Lap Info */
        #raceInfo {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 15px;
            border: 3px solid #FFD700;
            min-width: 250px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 20px;
        }

        .info-label {
            color: #FFD700;
        }

        .info-value {
            color: #00FF00;
            font-weight: bold;
        }

        /* Minimap */
        #minimap {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 200px;
            height: 200px;
            background: rgba(0, 0, 0, 0.8);
            border: 3px solid #FFD700;
            border-radius: 10px;
        }

        /* Timer */
        #timer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 72px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            pointer-events: none;
        }

        /* Countdown */
        #countdown {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 150px;
            font-weight: bold;
            color: #FF0000;
            text-shadow: 0 0 50px #FF0000;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
        }

        /* Boost Effect */
        #boostEffect {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 100px;
            color: #00FFFF;
            text-shadow: 0 0 50px #00FFFF;
            display: none;
            animation: boostAnim 1s ease-out;
        }

        @keyframes boostAnim {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.5); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }

        /* Menu */
        .menu-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 50px;
            border-radius: 20px;
            text-align: center;
            z-index: 1000;
            border: 5px solid #FFD700;
            min-width: 600px;
        }

        .menu-screen.hidden {
            display: none;
        }

        .menu-title {
            font-size: 72px;
            background: linear-gradient(45deg, #FF0000, #FFFF00, #00FF00, #00FFFF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            animation: rainbow 3s linear infinite;
        }

        @keyframes rainbow {
            to { filter: hue-rotate(360deg); }
        }

        .menu-subtitle {
            font-size: 28px;
            color: #FFD700;
            margin-bottom: 40px;
        }

        .menu-button {
            width: 100%;
            padding: 20px;
            margin: 15px 0;
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(135deg, #FF4444 0%, #CC0000 100%);
            border: 4px solid #FFD700;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .menu-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255, 68, 68, 0.8);
        }

        /* Car Selection */
        .car-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 30px 0;
        }

        .car-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }

        .car-card:hover {
            border-color: #FFD700;
            transform: scale(1.05);
        }

        .car-card.selected {
            border-color: #00FF00;
            background: rgba(0, 255, 0, 0.2);
        }

        .car-icon {
            font-size: 64px;
            margin-bottom: 10px;
        }

        .car-name {
            font-size: 20px;
            color: white;
            font-weight: bold;
        }

        .car-stats {
            font-size: 14px;
            color: #FFD700;
            margin-top: 10px;
        }

        /* Race Result */
        .race-result {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 50px;
            border-radius: 20px;
            text-align: center;
            z-index: 1000;
            border: 5px solid #FFD700;
            display: none;
            animation: slideIn 0.5s;
        }

        @keyframes slideIn {
            from { transform: translate(-50%, -100%); opacity: 0; }
            to { transform: translate(-50%, -50%); opacity: 1; }
        }

        .result-title {
            font-size: 72px;
            margin-bottom: 30px;
        }

        .result-title.win {
            color: #00FF00;
            text-shadow: 0 0 30px #00FF00;
        }

        .result-title.lose {
            color: #FF0000;
            text-shadow: 0 0 30px #FF0000;
        }

        .result-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }

        .result-stat {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
        }

        .stat-label {
            font-size: 16px;
            color: #FFD700;
        }

        .stat-value {
            font-size: 36px;
            color: white;
            font-weight: bold;
        }

        /* Nitro Bar */
        #nitroBar {
            position: absolute;
            bottom: 30px;
            left: 30px;
            width: 300px;
        }

        .nitro-label {
            font-size: 20px;
            color: #FFD700;
            margin-bottom: 10px;
        }

        .nitro-container {
            width: 100%;
            height: 30px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            border: 3px solid #00FFFF;
            overflow: hidden;
        }

        .nitro-fill {
            height: 100%;
            background: linear-gradient(90deg, #00FFFF, #0080FF);
            transition: width 0.1s;
            box-shadow: 0 0 20px #00FFFF;
        }

        /* Drift Indicator */
        #driftIndicator {
            position: absolute;
            top: 200px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 48px;
            color: #FF00FF;
            text-shadow: 0 0 20px #FF00FF;
            display: none;
        }

        /* Particles */
        .particle {
            position: absolute;
            pointer-events: none;
            animation: particleFloat 1s ease-out forwards;
        }

        @keyframes particleFloat {
            0% { opacity: 1; transform: translate(0, 0) scale(1); }
            100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0); }
        }

        /* Mobile Controls */
        .mobile-controls {
            position: absolute;
            bottom: 50px;
            width: 100%;
            display: none;
            justify-content: space-between;
            padding: 0 30px;
            pointer-events: all;
        }

        @media (max-width: 768px) {
            .mobile-controls {
                display: flex;
            }
        }

        .control-stick {
            width: 120px;
            height: 120px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border: 3px solid #FFD700;
            position: relative;
        }

        .stick-knob {
            width: 60px;
            height: 60px;
            background: #FFD700;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .control-buttons {
            display: flex;
            gap: 20px;
        }

        .control-btn {
            width: 80px;
            height: 80px;
            background: rgba(255, 0, 0, 0.7);
            border-radius: 50%;
            border: 3px solid #FFD700;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
            cursor: pointer;
        }

        .control-btn:active {
            transform: scale(0.9);
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        
        <div id="hud">
            <!-- Speedometer -->
            <div id="speedometer">
                <div id="speedValue">0</div>
                <div id="speedLabel">KM/H</div>
            </div>

            <!-- Race Info -->
            <div id="raceInfo">
                <div class="info-item">
                    <span class="info-label">Position:</span>
                    <span class="info-value" id="position">1st / 8</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Lap:</span>
                    <span class="info-value" id="lap">1 / 3</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Best Time:</span>
                    <span class="info-value" id="bestTime">--:--</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Score:</span>
                    <span class="info-value" id="score">0</span>
                </div>
            </div>

            <!-- Minimap -->
            <canvas id="minimap" width="200" height="200"></canvas>

            <!-- Timer -->
            <div id="timer"></div>

            <!-- Countdown -->
            <div id="countdown"></div>

            <!-- Boost Effect -->
            <div id="boostEffect">⚡ BOOST! ⚡</div>

            <!-- Drift Indicator -->
            <div id="driftIndicator">🔥 DRIFT COMBO! 🔥</div>

            <!-- Nitro Bar -->
            <div id="nitroBar">
                <div class="nitro-label">NITRO</div>
                <div class="nitro-container">
                    <div class="nitro-fill" id="nitroFill" style="width: 100%"></div>
                </div>
            </div>
        </div>

        <!-- Menu Screen -->
        <div id="menuScreen" class="menu-screen">
            <div class="menu-title">🏎️ 3D RACING</div>
            <div class="menu-subtitle">Ultimate Edition</div>
            <button class="menu-button" onclick="game.showCarSelect()">
                🚗 START RACE
            </button>
            <button class="menu-button" onclick="game.showTracks()">
                🏁 SELECT TRACK
            </button>
            <button class="menu-button" onclick="game.showSettings()">
                ⚙️ SETTINGS
            </button>
        </div>

        <!-- Car Selection -->
        <div id="carSelect" class="menu-screen hidden">
            <h2 style="color: #FFD700; font-size: 48px; margin-bottom: 30px;">Choose Your Car</h2>
            <div class="car-grid" id="carGrid"></div>
            <button class="menu-button" onclick="game.startRace()">
                START RACE
            </button>
        </div>

        <!-- Race Result -->
        <div id="raceResult" class="race-result">
            <div class="result-title" id="resultTitle">VICTORY!</div>
            <div class="result-stats">
                <div class="result-stat">
                    <div class="stat-label">Final Position</div>
                    <div class="stat-value" id="finalPosition">1st</div>
                </div>
                <div class="result-stat">
                    <div class="stat-label">Best Lap</div>
                    <div class="stat-value" id="finalBestLap">00:00</div>
                </div>
                <div class="result-stat">
                    <div class="stat-label">Total Score</div>
                    <div class="stat-value" id="finalScore">0</div>
                </div>
                <div class="result-stat">
                    <div class="stat-label">Max Speed</div>
                    <div class="stat-value" id="finalMaxSpeed">0</div>
                </div>
            </div>
            <button class="menu-button" onclick="game.restart()">
                🔄 RACE AGAIN
            </button>
            <button class="menu-button" onclick="game.backToMenu()">
                🏠 MAIN MENU
            </button>
        </div>

        <!-- Mobile Controls -->
        <div class="mobile-controls">
            <div class="control-stick">
                <div class="stick-knob"></div>
            </div>
            <div class="control-buttons">
                <div class="control-btn" ontouchstart="game.accelerate()" ontouchend="game.stopAccelerate()">
                    ⬆️
                </div>
                <div class="control-btn" ontouchstart="game.useNitro()" ontouchend="game.stopNitro()">
                    ⚡
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== 3D RACING GAME ENGINE ====================
        
        class RacingGame {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.minimap = document.getElementById('minimap');
                this.minimapCtx = this.minimap.getContext('2d');
                
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                
                // Game state
                this.gameState = 'menu'; // menu, countdown, racing, finished
                this.paused = false;
                
                // Cars
                this.cars = [
                    { icon: '🏎️', name: 'Formula One', speed: 10, acceleration: 0.5, handling: 8 },
                    { icon: '🚗', name: 'Sports Car', speed: 8, acceleration: 0.7, handling: 9 },
                    { icon: '🚙', name: 'Rally Car', speed: 7, acceleration: 0.8, handling: 10 },
                    { icon: '🚕', name: 'Taxi', speed: 6, acceleration: 0.6, handling: 7 },
                    { icon: '🚐', name: 'Van', speed: 5, acceleration: 0.4, handling: 6 },
                    { icon: '🏁', name: 'Race Pro', speed: 12, acceleration: 0.6, handling: 7 }
                ];
                this.selectedCar = 0;
                
                // Player
                this.player = {
                    x: 0,
                    y: 0,
                    z: 0,
                    speed: 0,
                    maxSpeed: 10,
                    acceleration: 0.5,
                    brake: 0.8,
                    handling: 8,
                    angle: 0,
                    drift: 0,
                    lap: 1,
                    position: 1,
                    checkpoints: [],
                    nitro: 100,
                    usingNitro: false
                };
                
                // AI Cars
                this.aiCars = [];
                this.numAICars = 7;
                
                // Track
                this.trackWidth = 40;
                this.trackLength = 1000;
                this.trackSegments = [];
                this.camera = { x: 0, y: 1000, z: 0, height: 1500 };
                
                // Race
                this.laps = 3;
                this.raceTime = 0;
                this.bestLapTime = Infinity;
                this.currentLapTime = 0;
                this.score = 0;
                this.maxSpeed = 0;
                
                // Input
                this.keys = {};
                
                // Animation
                this.lastTime = 0;
                
                this.initialize();
                this.setupEventListeners();
                this.showCarSelection();
            }
            
            initialize() {
                this.generateTrack();
                this.generateAICars();
            }
            
            generateTrack() {
                // Create a circular track with elevation changes
                const numSegments = 100;
                const radius = 300;
                
                for (let i = 0; i < numSegments; i++) {
                    const angle = (i / numSegments) * Math.PI * 2;
                    const nextAngle = ((i + 1) / numSegments) * Math.PI * 2;
                    
                    // Add some curves and elevation
                    const curve = Math.sin(angle * 3) * 50;
                    const elevation = Math.sin(angle * 2) * 100;
                    
                    this.trackSegments.push({
                        x1: Math.cos(angle) * (radius + curve),
                        z1: Math.sin(angle) * (radius + curve),
                        y1: elevation,
                        x2: Math.cos(nextAngle) * (radius + curve),
                        z2: Math.sin(nextAngle) * (radius + curve),
                        y2: Math.sin(nextAngle * 2) * 100,
                        width: this.trackWidth,
                        color: i % 10 === 0 ? '#FFFFFF' : '#333333'
                    });
                }
            }
            
            generateAICars() {
                for (let i = 0; i < this.numAICars; i++) {
                    this.aiCars.push({
                        x: Math.random() * 10 - 5,
                        y: 0,
                        z: -50 - i * 50,
                        speed: 6 + Math.random() * 3,
                        maxSpeed: 8 + Math.random() * 4,
                        angle: 0,
                        lap: 1,
                        checkpoints: [],
                        icon: this.cars[Math.floor(Math.random() * this.cars.length)].icon
                    });
                }
            }
            
            setupEventListeners() {
                document.addEventListener('keydown', (e) => {
                    this.keys[e.code] = true;
                    
                    if (e.code === 'ShiftLeft' || e.code === 'ShiftRight') {
                        this.useNitro();
                    }
                });
                
                document.addEventListener('keyup', (e) => {
                    this.keys[e.code] = false;
                    
                    if (e.code === 'ShiftLeft' || e.code === 'ShiftRight') {
                        this.stopNitro();
                    }
                });
                
                window.addEventListener('resize', () => {
                    this.canvas.width = window.innerWidth;
                    this.canvas.height = window.innerHeight;
                });
            }
            
            showCarSelection() {
                const grid = document.getElementById('carGrid');
                grid.innerHTML = '';
                
                this.cars.forEach((car, index) => {
                    const card = document.createElement('div');
                    card.className = 'car-card';
                    if (index === this.selectedCar) card.classList.add('selected');
                    
                    card.innerHTML = `
                        <div class="car-icon">${car.icon}</div>
                        <div class="car-name">${car.name}</div>
                        <div class="car-stats">
                            Speed: ${car.speed}/10<br>
                            Accel: ${car.acceleration * 10}/10<br>
                            Handle: ${car.handling}/10
                        </div>
                    `;
                    
                    card.onclick = () => {
                        this.selectedCar = index;
                        document.querySelectorAll('.car-card').forEach(c => c.classList.remove('selected'));
                        card.classList.add('selected');
                    };
                    
                    grid.appendChild(card);
                });
                
                document.getElementById('menuScreen').classList.add('hidden');
                document.getElementById('carSelect').classList.remove('hidden');
            }
            
            startRace() {
                document.getElementById('carSelect').classList.add('hidden');
                
                // Apply selected car stats
                const car = this.cars[this.selectedCar];
                this.player.maxSpeed = car.speed;
                this.player.acceleration = car.acceleration;
                this.player.handling = car.handling;
                
                // Reset player
                this.player.x = 0;
                this.player.y = 0;
                this.player.z = 0;
                this.player.speed = 0;
                this.player.angle = 0;
                this.player.lap = 1;
                this.player.checkpoints = [];
                this.player.nitro = 100;
                
                // Reset race stats
                this.raceTime = 0;
                this.currentLapTime = 0;
                this.bestLapTime = Infinity;
                this.score = 0;
                this.maxSpeed = 0;
                
                // Reset AI
                this.generateAICars();
                
                this.gameState = 'countdown';
                this.countdown(3);
            }
            
            countdown(num) {
                const countdownEl = document.getElementById('countdown');
                countdownEl.style.display = 'block';
                
                if (num > 0) {
                    countdownEl.textContent = num;
                    countdownEl.style.color = '#FF0000';
                    setTimeout(() => this.countdown(num - 1), 1000);
                } else {
                    countdownEl.textContent = 'GO!';
                    countdownEl.style.color = '#00FF00';
                    setTimeout(() => {
                        countdownEl.style.display = 'none';
                        this.gameState = 'racing';
                        this.gameLoop(0);
                    }, 500);
                }
            }
            
            gameLoop(timestamp) {
                if (this.gameState !== 'racing') return;
                
                const deltaTime = (timestamp - this.lastTime) / 1000;
                this.lastTime = timestamp;
                
                this.update(deltaTime);
                this.render();
                
                requestAnimationFrame((t) => this.gameLoop(t));
            }
            
            update(dt) {
                // Player controls
                if (this.keys['ArrowUp'] || this.keys['KeyW']) {
                    this.player.speed = Math.min(
                        this.player.speed + this.player.acceleration,
                        this.player.usingNitro ? this.player.maxSpeed * 1.5 : this.player.maxSpeed
                    );
                } else if (this.keys['ArrowDown'] || this.keys['KeyS']) {
                    this.player.speed = Math.max(this.player.speed - this.player.brake, -this.player.maxSpeed * 0.5);
                } else {
                    this.player.speed *= 0.98; // Friction
                }
                
                if (this.keys['ArrowLeft'] || this.keys['KeyA']) {
                    this.player.angle -= 0.05 * (this.player.speed / this.player.maxSpeed) * this.player.handling * 0.1;
                    this.player.drift = -1;
                }
                else if (this.keys['ArrowRight'] || this.keys['KeyD']) {
                    this.player.angle += 0.05 * (this.player.speed / this.player.maxSpeed) * this.player.handling * 0.1;
                    this.player.drift = 1;
                } else {
                    this.player.drift *= 0.9;
                }
                
                // Show drift indicator
                if (Math.abs(this.player.drift) > 0.5 && this.player.speed > 5) {
                    document.getElementById('driftIndicator').style.display = 'block';
                    this.score += Math.floor(Math.abs(this.player.drift) * 10);
                } else {
                    document.getElementById('driftIndicator').style.display = 'none';
                }
                
                // Update player position
                this.player.x += Math.sin(this.player.angle) * this.player.speed;
                this.player.z += Math.cos(this.player.angle) * this.player.speed;
                
                // Update nitro
                if (this.player.usingNitro && this.player.nitro > 0) {
                    this.player.nitro -= 50 * dt;
                    this.player.nitro = Math.max(0, this.player.nitro);
                    this.createNitroParticles();
                } else {
                    this.player.nitro = Math.min(100, this.player.nitro + 10 * dt);
                    if (this.player.nitro <= 0) {
                        this.player.usingNitro = false;
                    }
                }
                
                // Keep player on track (simplified)
                const trackRadius = 300;
                const distFromCenter = Math.sqrt(this.player.x * this.player.x + this.player.z * this.player.z);
                if (distFromCenter > trackRadius + this.trackWidth / 2) {
                    const angle = Math.atan2(this.player.x, this.player.z);
                    this.player.x = Math.sin(angle) * (trackRadius + this.trackWidth / 2);
                    this.player.z = Math.cos(angle) * (trackRadius + this.trackWidth / 2);
                    this.player.speed *= 0.5; // Slow down when off track
                }
                
                // Update AI cars
                this.updateAI(dt);
                
                // Update camera
                this.camera.x = this.player.x;
                this.camera.z = this.player.z - 50;
                
                // Check lap completion
                this.checkLapCompletion();
                
                // Update timers
                this.raceTime += dt;
                this.currentLapTime += dt;
                
                // Update max speed
                this.maxSpeed = Math.max(this.maxSpeed, Math.abs(this.player.speed));
                
                // Update position
                this.updatePosition();
                
                // Update HUD
                this.updateHUD();
            }
            
            updateAI(dt) {
                this.aiCars.forEach(ai => {
                    // Simple AI: follow track
                    const targetAngle = Math.atan2(ai.x, ai.z);
                    const angleDiff = targetAngle - ai.angle;
                    
                    ai.angle += angleDiff * 0.05;
                    ai.speed = Math.min(ai.speed + 0.3, ai.maxSpeed);
                    
                    ai.x += Math.sin(ai.angle) * ai.speed;
                    ai.z += Math.cos(ai.angle) * ai.speed;
                    
                    // Keep on track
                    const trackRadius = 300;
                    const distFromCenter = Math.sqrt(ai.x * ai.x + ai.z * ai.z);
                    if (distFromCenter > trackRadius + this.trackWidth / 2) {
                        const angle = Math.atan2(ai.x, ai.z);
                        ai.x = Math.sin(angle) * (trackRadius + this.trackWidth / 2);
                        ai.z = Math.cos(angle) * (trackRadius + this.trackWidth / 2);
                    }
                    
                    // Check lap
                    const prevZ = ai.z - ai.speed;
                    if (prevZ < 0 && ai.z >= 0) {
                        ai.lap++;
                    }
                });
            }
            
            checkLapCompletion() {
                // Simple lap detection based on crossing start line
                const prevZ = this.player.z - this.player.speed;
                if (prevZ < 0 && this.player.z >= 0 && this.player.lap <= this.laps) {
                    if (this.currentLapTime < this.bestLapTime) {
                        this.bestLapTime = this.currentLapTime;
                    }
                    this.currentLapTime = 0;
                    this.player.lap++;
                    this.score += 1000;
                    
                    if (this.player.lap > this.laps) {
                        this.finishRace();
                    }
                }
            }
            
            updatePosition() {
                let position = 1;
                this.aiCars.forEach(ai => {
                    if (ai.lap > this.player.lap || (ai.lap === this.player.lap && ai.z > this.player.z)) {
                        position++;
                    }
                });
                this.player.position = position;
            }
            
            useNitro() {
                if (this.player.nitro > 0) {
                    this.player.usingNitro = true;
                    document.getElementById('boostEffect').style.display = 'block';
                    setTimeout(() => {
                        document.getElementById('boostEffect').style.display = 'none';
                    }, 1000);
                }
            }
            
            stopNitro() {
                this.player.usingNitro = false;
            }
            
            createNitroParticles() {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.textContent = '💨';
                particle.style.left = (this.canvas.width / 2 - 50) + 'px';
                particle.style.bottom = '200px';
                particle.style.setProperty('--tx', (Math.random() - 0.5) * 100 + 'px');
                particle.style.setProperty('--ty', (Math.random() * 50 + 50) + 'px');
                document.body.appendChild(particle);
                
                setTimeout(() => particle.remove(), 1000);
            }
            
            finishRace() {
                this.gameState = 'finished';
                
                const positions = ['1st', '2nd', '3rd', '4th', '5th', '6th', '7th', '8th'];
                
                document.getElementById('resultTitle').textContent = 
                    this.player.position <= 3 ? 'VICTORY!' : 'RACE FINISHED!';
                document.getElementById('resultTitle').className = 
                    'result-title ' + (this.player.position <= 3 ? 'win' : 'lose');
                
                document.getElementById('finalPosition').textContent = positions[this.player.position - 1];
                document.getElementById('finalBestLap').textContent = this.formatTime(this.bestLapTime);
                document.getElementById('finalScore').textContent = this.score;
                document.getElementById('finalMaxSpeed').textContent = Math.floor(this.maxSpeed * 20) + ' km/h';
                
                document.getElementById('raceResult').style.display = 'block';
            }
            
            render() {
                // Clear canvas
                this.ctx.fillStyle = '#87CEEB';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Draw ground
                this.ctx.fillStyle = '#228B22';
                this.ctx.fillRect(0, this.canvas.height / 2, this.canvas.width, this.canvas.height / 2);
                
                // Draw track (pseudo-3D)
                this.renderTrack();
                
                // Draw cars
                this.renderCars();
                
                // Draw minimap
                this.renderMinimap();
            }
            
            renderTrack() {
                const horizon = this.canvas.height / 2;
                const roadWidth = 400;
                
                // Draw road strips
                for (let i = 0; i < 20; i++) {
                    const depth = i / 20;
                    const y = horizon + (this.canvas.height / 2) * depth;
                    const width = roadWidth * (1 - depth * 0.7);
                    
                    // Road
                    this.ctx.fillStyle = i % 2 === 0 ? '#333333' : '#444444';
                    this.ctx.fillRect(
                        this.canvas.width / 2 - width / 2,
                        y,
                        width,
                        this.canvas.height / 20
                    );
                    
                    // Road markings
                    if (i % 3 === 0) {
                        this.ctx.fillStyle = '#FFFFFF';
                        this.ctx.fillRect(
                            this.canvas.width / 2 - 5,
                            y,
                            10,
                            this.canvas.height / 20
                        );
                    }
                    
                    // Side barriers
                    this.ctx.fillStyle = '#FF0000';
                    this.ctx.fillRect(
                        this.canvas.width / 2 - width / 2 - 20,
                        y,
                        20,
                        this.canvas.height / 20
                    );
                    this.ctx.fillRect(
                        this.canvas.width / 2 + width / 2,
                        y,
                        20,
                        this.canvas.height / 20
                    );
                }
            }
            
            renderCars() {
                // Draw AI cars
                this.aiCars.forEach(ai => {
                    const relativeZ = ai.z - this.player.z;
                    if (relativeZ > 0 && relativeZ < 200) {
                        const depth = relativeZ / 200;
                        const y = this.canvas.height / 2 + (this.canvas.height / 4) * depth;
                        const scale = 1 - depth * 0.7;
                        const size = 60 * scale;
                        
                        this.ctx.font = size + 'px Arial';
                        this.ctx.textAlign = 'center';
                        this.ctx.fillText(
                            ai.icon,
                            this.canvas.width / 2 + (ai.x - this.player.x) * 10 * scale,
                            y
                        );
                    }
                });
                
                // Draw player car
                this.ctx.font = '80px Arial';
                this.ctx.textAlign = 'center';
                this.ctx.fillText(
                    this.cars[this.selectedCar].icon,
                    this.canvas.width / 2,
                    this.canvas.height - 100
                );
                
                // Nitro effect
                if (this.player.usingNitro) {
                    this.ctx.font = '40px Arial';
                    this.ctx.fillText('💨', this.canvas.width / 2, this.canvas.height - 60);
                }
            }
            
            renderMinimap() {
                const ctx = this.minimapCtx;
                const centerX = 100;
                const centerY = 100;
                const scale = 0.3;
                
                // Clear
                ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                ctx.fillRect(0, 0, 200, 200);
                
                // Track
                ctx.strokeStyle = '#FFFFFF';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(centerX, centerY, 80, 0, Math.PI * 2);
                ctx.stroke();
                
                // Player
                ctx.fillStyle = '#00FF00';
                ctx.beginPath();
                ctx.arc(
                    centerX + this.player.x * scale,
                    centerY + this.player.z * scale,
                    5, 0, Math.PI * 2
                );
                ctx.fill();
                
                // AI cars
                ctx.fillStyle = '#FF0000';
                this.aiCars.forEach(ai => {
                    ctx.beginPath();
                    ctx.arc(
                        centerX + ai.x * scale,
                        centerY + ai.z * scale,
                        3, 0, Math.PI * 2
                    );
                    ctx.fill();
                });
            }
            
            updateHUD() {
                const speed = Math.floor(Math.abs(this.player.speed) * 20);
                document.getElementById('speedValue').textContent = speed;
                
                const positions = ['1st', '2nd', '3rd', '4th', '5th', '6th', '7th', '8th'];
                document.getElementById('position').textContent = 
                    positions[this.player.position - 1] + ' / ' + (this.numAICars + 1);
                
                document.getElementById('lap').textContent = 
                    this.player.lap + ' / ' + this.laps;
                
                document.getElementById('bestTime').textContent = 
                    this.bestLapTime < Infinity ? this.formatTime(this.bestLapTime) : '--:--';
                
                document.getElementById('score').textContent = this.score;
                
                document.getElementById('timer').textContent = this.formatTime(this.raceTime);
                
                // Nitro bar
                document.getElementById('nitroFill').style.width = this.player.nitro + '%';
            }
            
            formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                const ms = Math.floor((seconds % 1) * 100);
                return `${mins}:${secs.toString().padStart(2, '0')}.${ms.toString().padStart(2, '0')}`;
            }
            
            restart() {
                document.getElementById('raceResult').style.display = 'none';
                this.startRace();
            }
            
            backToMenu() {
                document.getElementById('raceResult').style.display = 'none';
                document.getElementById('menuScreen').classList.remove('hidden');
                this.gameState = 'menu';
            }
            
            showTracks() {
                alert('🏁 TRACK SELECTION\n\nAvailable Tracks:\n• City Circuit\n• Mountain Pass\n• Desert Highway\n• Night Tokyo\n\nMore tracks coming soon!');
            }
            
            showSettings() {
                alert('⚙️ SETTINGS\n\nGraphics: High\nSound: ON\nDifficulty: Medium\nLaps: 3');
            }
        }
        
        // Initialize game
        const game = new RacingGame();
        window.game = game;
        
        console.log('%c🏎️ 3D RACING GAME LOADED! 🏎️', 'color: #FF0000; font-size: 24px; font-weight: bold;');
    </script>
</body>
</html>
