<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Mario Bros - Ultimate Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial Black', Arial, sans-serif;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        #gameContainer {
            position: relative;
            box-shadow: 0 0 50px rgba(255, 0, 0, 0.5);
            border-radius: 10px;
            overflow: hidden;
        }

        #gameCanvas {
            display: block;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        /* HUD Overlay */
        #hudOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
            color: white;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
            z-index: 100;
        }

        .hud-item {
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .hud-label {
            color: #FFD700;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .hud-value {
            font-size: 28px;
            color: white;
        }

        /* Power-up Display */
        #powerupDisplay {
            position: absolute;
            top: 100px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            border: 3px solid #FFD700;
            color: white;
            min-width: 150px;
        }

        .powerup-title {
            color: #FFD700;
            font-size: 16px;
            margin-bottom: 10px;
            text-align: center;
        }

        .powerup-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 5px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
        }

        .powerup-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        /* Menu Screen */
        .menu-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            padding: 50px;
            border-radius: 20px;
            text-align: center;
            z-index: 1000;
            border: 5px solid #FF0000;
            min-width: 500px;
        }

        .menu-screen.hidden {
            display: none;
        }

        .menu-title {
            font-size: 72px;
            color: #FF0000;
            text-shadow: 4px 4px 0px #8B0000;
            margin-bottom: 10px;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .menu-subtitle {
            font-size: 32px;
            color: #FFD700;
            margin-bottom: 40px;
        }

        .menu-button {
            width: 100%;
            padding: 20px;
            margin: 15px 0;
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(180deg, #FF4444 0%, #CC0000 100%);
            border: 4px solid #FFD700;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .menu-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255, 68, 68, 0.8);
        }

        /* Level Complete */
        .level-complete {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            padding: 50px;
            border-radius: 20px;
            text-align: center;
            z-index: 1000;
            border: 5px solid #00FF00;
            display: none;
            animation: slideIn 0.5s;
        }

        @keyframes slideIn {
            from {
                transform: translate(-50%, -100%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%);
                opacity: 1;
            }
        }

        .level-complete-title {
            font-size: 64px;
            color: #00FF00;
            margin-bottom: 30px;
            text-shadow: 0 0 20px rgba(0, 255, 0, 0.8);
        }

        .stars {
            font-size: 72px;
            margin: 20px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }

        .stat-box {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            color: white;
        }

        .stat-label {
            font-size: 16px;
            color: #FFD700;
        }

        .stat-value {
            font-size: 36px;
            color: white;
            font-weight: bold;
        }

        /* Lives Display */
        #livesDisplay {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 32px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        /* Instructions */
        .instructions {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 15px 30px;
            border-radius: 10px;
            color: white;
            font-size: 18px;
            text-align: center;
            pointer-events: none;
        }

        .key {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 5px;
            margin: 0 5px;
            font-weight: bold;
            color: #FFD700;
        }

        /* Particle */
        .particle {
            position: absolute;
            pointer-events: none;
            font-size: 24px;
            animation: particleFloat 1s ease-out forwards;
        }

        @keyframes particleFloat {
            0% {
                opacity: 1;
                transform: translate(0, 0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(var(--tx), var(--ty)) scale(0);
            }
        }

        /* Achievement Notification */
        .achievement {
            position: absolute;
            top: 150px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            padding: 20px 40px;
            border-radius: 15px;
            border: 3px solid #FFD700;
            color: white;
            font-size: 20px;
            font-weight: bold;
            z-index: 999;
            animation: achievementSlide 3s ease-out forwards;
        }

        @keyframes achievementSlide {
            0%, 100% {
                transform: translate(-50%, -100px);
                opacity: 0;
            }
            10%, 90% {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="1200" height="700"></canvas>
        
        <!-- HUD Overlay -->
        <div id="hudOverlay">
            <div class="hud-item">
                <div class="hud-label">SCORE</div>
                <div class="hud-value" id="scoreDisplay">000000</div>
            </div>
            <div class="hud-item">
                <div class="hud-label">COINS</div>
                <div class="hud-value" id="coinsDisplay">√ó 0</div>
            </div>
            <div class="hud-item">
                <div class="hud-label">WORLD</div>
                <div class="hud-value" id="worldDisplay">1-1</div>
            </div>
            <div class="hud-item">
                <div class="hud-label">TIME</div>
                <div class="hud-value" id="timeDisplay">300</div>
            </div>
        </div>

        <!-- Lives Display -->
        <div id="livesDisplay">üçÑ √ó <span id="livesCount">3</span></div>

        <!-- Power-up Display -->
        <div id="powerupDisplay">
            <div class="powerup-title">POWER-UPS</div>
            <div class="powerup-item">
                <span class="powerup-icon">üçÑ</span>
                <span id="mushroomStatus">Ready</span>
            </div>
            <div class="powerup-item">
                <span class="powerup-icon">üåü</span>
                <span id="starStatus">Ready</span>
            </div>
            <div class="powerup-item">
                <span class="powerup-icon">üî•</span>
                <span id="fireStatus">Ready</span>
            </div>
        </div>

        <!-- Menu Screen -->
        <div id="menuScreen" class="menu-screen">
            <div class="menu-title">SUPER MARIO</div>
            <div class="menu-subtitle">Ultimate Edition</div>
            <button class="menu-button" onclick="game.startGame()">
                üéÆ START GAME
            </button>
            <button class="menu-button" onclick="game.showLevelSelect()">
                üó∫Ô∏è SELECT LEVEL
            </button>
            <button class="menu-button" onclick="game.showControls()">
                üéØ CONTROLS
            </button>
        </div>

        <!-- Level Complete -->
        <div id="levelComplete" class="level-complete">
            <div class="level-complete-title">LEVEL COMPLETE!</div>
            <div class="stars" id="starsEarned">‚≠ê‚≠ê‚≠ê</div>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">SCORE</div>
                    <div class="stat-value" id="finalScore">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">COINS</div>
                    <div class="stat-value" id="finalCoins">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">TIME BONUS</div>
                    <div class="stat-value" id="timeBonus">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">ENEMIES</div>
                    <div class="stat-value" id="enemiesKilled">0</div>
                </div>
            </div>
            <button class="menu-button" onclick="game.nextLevel()">
                ‚û°Ô∏è NEXT LEVEL
            </button>
            <button class="menu-button" onclick="game.backToMenu()">
                üè† MAIN MENU
            </button>
        </div>

        <!-- Instructions -->
        <div class="instructions">
            <span class="key">‚Üê</span> <span class="key">‚Üí</span> Move
            <span class="key">Space</span> Jump
            <span class="key">Shift</span> Run
            <span class="key">F</span> Fire
        </div>
    </div>

    <script>
        // ==================== SUPER MARIO GAME ENGINE ====================
        
        class SuperMario {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                
                // Game state
                this.gameState = 'menu'; // menu, playing, paused, levelComplete
                this.currentLevel = 1;
                this.currentWorld = 1;
                
                // Player stats
                this.score = 0;
                this.coins = 0;
                this.lives = 3;
                this.time = 300;
                this.enemiesKilled = 0;
                
                // Mario
                this.mario = {
                    x: 100,
                    y: 500,
                    width: 32,
                    height: 32,
                    velocityX: 0,
                    velocityY: 0,
                    speed: 5,
                    maxSpeed: 8,
                    jumpPower: -15,
                    gravity: 0.8,
                    grounded: false,
                    direction: 'right',
                    state: 'small', // small, big, fire
                    invincible: false,
                    invincibleTime: 0,
                    canFire: false
                };
                
                // Camera
                this.camera = {
                    x: 0,
                    y: 0
                };
                
                // Input
                this.keys = {};
                
                // World
                this.blocks = [];
                this.enemies = [];
                this.items = [];
                this.pipes = [];
                this.coins_world = [];
                this.fireballs = [];
                this.particles = [];
                
                // Level data
                this.levelWidth = 5000;
                this.groundLevel = 620;
                
                // Animation
                this.animationFrame = 0;
                this.lastTime = 0;
                
                this.initialize();
                this.setupEventListeners();
            }
            
            initialize() {
                // Generate level
                this.generateLevel();
            }
            
            setupEventListeners() {
                // Keyboard
                document.addEventListener('keydown', (e) => {
                    this.keys[e.code] = true;
                    
                    if (e.code === 'Space' && this.gameState === 'playing') {
                        if (this.mario.grounded) {
                            this.mario.velocityY = this.mario.jumpPower;
                            this.mario.grounded = false;
                            this.createParticles(this.mario.x + 16, this.mario.y + this.mario.height, 5);
                        }
                    }
                    
                    if (e.code === 'KeyF' && this.gameState === 'playing' && this.mario.canFire) {
                        this.shootFireball();
                    }
                });
                
                document.addEventListener('keyup', (e) => {
                    this.keys[e.code] = false;
                });
            }
            
            generateLevel() {
                this.blocks = [];
                this.enemies = [];
                this.items = [];
                this.pipes = [];
                this.coins_world = [];
                
                // Ground blocks
                for (let i = 0; i < 200; i++) {
                    this.blocks.push({
                        x: i * 40,
                        y: this.groundLevel,
                        width: 40,
                        height: 40,
                        type: 'ground'
                    });
                }
                
                // Question blocks with power-ups
                const questionBlocks = [
                    { x: 400, y: 400, item: 'mushroom' },
                    { x: 600, y: 400, item: 'coin' },
                    { x: 800, y: 400, item: 'star' },
                    { x: 1200, y: 350, item: 'fireflower' },
                    { x: 1600, y: 400, item: 'coin' },
                    { x: 2000, y: 400, item: 'mushroom' },
                    { x: 2400, y: 350, item: 'star' }
                ];
                
                questionBlocks.forEach(block => {
                    this.blocks.push({
                        x: block.x,
                        y: block.y,
                        width: 40,
                        height: 40,
                        type: 'question',
                        item: block.item,
                        hit: false
                    });
                });
                
                // Brick blocks
                for (let i = 0; i < 20; i++) {
                    this.blocks.push({
                        x: 1000 + i * 40,
                        y: 400,
                        width: 40,
                        height: 40,
                        type: 'brick',
                        breakable: true
                    });
                }
                
                // Platforms
                const platforms = [
                    { x: 500, y: 500, width: 3 },
                    { x: 900, y: 450, width: 4 },
                    { x: 1400, y: 400, width: 5 },
                    { x: 1800, y: 350, width: 3 },
                    { x: 2200, y: 500, width: 4 }
                ];
                
                platforms.forEach(platform => {
                    for (let i = 0; i < platform.width; i++) {
                        this.blocks.push({
                            x: platform.x + i * 40,
                            y: platform.y,
                            width: 40,
                            height: 40,
                            type: 'platform'
                        });
                    }
                });
                
                // Pipes
                const pipes = [
                    { x: 700, height: 2 },
                    { x: 1100, height: 3 },
                    { x: 1700, height: 2 },
                    { x: 2300, height: 4 }
                ];
                
                pipes.forEach(pipe => {
                    this.pipes.push({
                        x: pipe.x,
                        y: this.groundLevel - pipe.height * 40,
                        width: 80,
                        height: pipe.height * 40
                    });
                });
                
                // Enemies (Goombas and Koopas)
                const enemyPositions = [
                    { x: 600, type: 'goomba' },
                    { x: 900, type: 'koopa' },
                    { x: 1300, type: 'goomba' },
                    { x: 1500, type: 'goomba' },
                    { x: 1900, type: 'koopa' },
                    { x: 2200, type: 'goomba' },
                    { x: 2500, type: 'koopa' },
                    { x: 2800, type: 'goomba' }
                ];
                
                enemyPositions.forEach(enemy => {
                    this.enemies.push({
                        x: enemy.x,
                        y: this.groundLevel - 40,
                        width: 32,
                        height: 32,
                        type: enemy.type,
                        velocityX: -2,
                        velocityY: 0,
                        alive: true,
                        stunned: false
                    });
                });
                
                // Floating coins
                for (let i = 0; i < 30; i++) {
                    this.coins_world.push({
                        x: 300 + i * 150 + Math.random() * 50,
                        y: 200 + Math.random() * 200,
                        width: 30,
                        height: 30,
                        rotation: 0,
                        collected: false
                    });
                }
                
                // Flag pole (end of level)
                this.flagPole = {
                    x: 4500,
                    y: 300,
                    width: 20,
                    height: 320
                };
            }
            
            startGame() {
                document.getElementById('menuScreen').classList.add('hidden');
                
                // Reset game
                this.gameState = 'playing';
                this.score = 0;
                this.coins = 0;
                this.lives = 3;
                this.time = 300;
                this.enemiesKilled = 0;
                
                this.mario.x = 100;
                this.mario.y = 500;
                this.mario.velocityX = 0;
                this.mario.velocityY = 0;
                this.mario.state = 'small';
                this.mario.invincible = false;
                this.mario.canFire = false;
                
                this.camera.x = 0;
                
                this.generateLevel();
                this.updateHUD();
                this.startTimer();
                this.gameLoop(0);
            }
            
            startTimer() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                }
                
                this.timerInterval = setInterval(() => {
                    if (this.gameState === 'playing') {
                        this.time--;
                        if (this.time <= 0) {
                            this.loseLife();
                        }
                        this.updateHUD();
                    }
                }, 1000);
            }
            
            gameLoop(timestamp) {
                if (this.gameState !== 'playing') return;
                
                const deltaTime = timestamp - this.lastTime;
                this.lastTime = timestamp;
                
                this.update(deltaTime);
                this.render();
                
                requestAnimationFrame((t) => this.gameLoop(t));
            }
            
            update(dt) {
                this.animationFrame += dt / 16;
                
                // Mario controls
                if (this.keys['ArrowLeft'] || this.keys['KeyA']) {
                    this.mario.velocityX = -this.mario.speed;
                    this.mario.direction = 'left';
                } else if (this.keys['ArrowRight'] || this.keys['KeyD']) {
                    const runSpeed = this.keys['ShiftLeft'] || this.keys['ShiftRight'] ? 
                        this.mario.maxSpeed : this.mario.speed;
                    this.mario.velocityX = runSpeed;
                    this.mario.direction = 'right';
                } else {
                    this.mario.velocityX *= 0.8;
                }
                
                // Gravity
                this.mario.velocityY += this.mario.gravity;
                
                // Update position
                this.mario.x += this.mario.velocityX;
                this.mario.y += this.mario.velocityY;
                
                // Collision with ground
                if (this.mario.y + this.mario.height >= this.groundLevel) {
                    this.mario.y = this.groundLevel - this.mario.height;
                    this.mario.velocityY = 0;
                    this.mario.grounded = true;
                }
                
                // Collision with blocks
                this.checkBlockCollisions();
                
                // Collision with enemies
                this.checkEnemyCollisions();
                
                // Collision with items
                this.checkItemCollisions();
                
                // Collision with coins
                this.checkCoinCollisions();
                
                // Check flag pole
                this.checkFlagPole();
                
                // Update camera
                this.camera.x = Math.max(0, this.mario.x - 400);
                this.camera.x = Math.min(this.camera.x, this.levelWidth - this.canvas.width);
                
                // Update enemies
                this.updateEnemies(dt);
                
                // Update items
                this.updateItems(dt);
                
                // Update fireballs
                this.updateFireballs(dt);
                
                // Update particles
                this.updateParticles(dt);
                
                // Invincibility timer
                if (this.mario.invincible) {
                    this.mario.invincibleTime -= dt;
                    if (this.mario.invincibleTime <= 0) {
                        this.mario.invincible = false;
                    }
                }
                
                // Prevent falling off world
                if (this.mario.y > this.canvas.height) {
                    this.loseLife();
                }
                
                // Boundaries
                this.mario.x = Math.max(0, Math.min(this.mario.x, this.levelWidth - this.mario.width));
            }
            
            checkBlockCollisions() {
                this.blocks.forEach(block => {
                    if (this.checkCollision(this.mario, block)) {
                        const overlapX = Math.min(
                            this.mario.x + this.mario.width - block.x,
                            block.x + block.width - this.mario.x
                        );
                        const overlapY = Math.min(
                            this.mario.y + this.mario.height - block.y,
                            block.y + block.height - this.mario.y
                        );
                        
                        if (overlapX < overlapY) {
                            // Horizontal collision
                            if (this.mario.x < block.x) {
                                this.mario.x = block.x - this.mario.width;
                            } else {
                                this.mario.x = block.x + block.width;
                            }
                            this.mario.velocityX = 0;
                        } else {
                            // Vertical collision
                            if (this.mario.y < block.y) {
                                // Hit from below
                                this.mario.y = block.y - this.mario.height;
                                this.mario.velocityY = 0;
                                this.mario.grounded = true;
                            } else {
                                // Hit from above
                                this.mario.y = block.y + block.height;
                                this.mario.velocityY = 0;
                                
                                // Hit question block
                                if (block.type === 'question' && !block.hit) {
                                    this.hitQuestionBlock(block);
                                }
                                
                                // Break brick
                                if (block.type === 'brick' && this.mario.state !== 'small') {
                                    this.breakBrick(block);
                                }
                            }
                        }
                    }
                });
            }
            
            hitQuestionBlock(block) {
                block.hit = true;
                block.type = 'used';
                
                // Spawn item
                if (block.item === 'coin') {
                    this.collectCoin();
                    this.createParticles(block.x + 20, block.y, 10, '#FFD700');
                } else if (block.item === 'mushroom') {
                    this.spawnItem(block.x, block.y - 40, 'mushroom');
                } else if (block.item === 'fireflower') {
                    this.spawnItem(block.x, block.y - 40, 'fireflower');
                } else if (block.item === 'star') {
                    this.spawnItem(block.x, block.y - 40, 'star');
                }
                
                this.score += 100;
                this.updateHUD();
            }
            
            breakBrick(block) {
                const index = this.blocks.indexOf(block);
                if (index > -1) {
                    this.blocks.splice(index, 1);
                    this.score += 50;
                    this.createParticles(block.x + 20, block.y + 20, 15, '#8B4513');
                    this.updateHUD();
                }
            }
            
            spawnItem(x, y, type) {
                this.items.push({
                    x: x,
                    y: y,
                    width: 32,
                    height: 32,
                    type: type,
                    velocityX: 2,
                    velocityY: 0,
                    gravity: 0.5
                });
            }
            
            updateItems(dt) {
                this.items.forEach((item, index) => {
                    item.velocityY += item.gravity;
                    item.x += item.velocityX;
                    item.y += item.velocityY;
                    
                    // Ground collision
                    if (item.y + item.height >= this.groundLevel) {
                        item.y = this.groundLevel - item.height;
                        item.velocityY = 0;
                    }
                    
                    // Block collision
                    this.blocks.forEach(block => {
                        if (this.checkCollision(item, block)) {
                            if (item.y < block.y) {
                                item.y = block.y - item.height;
                                item.velocityY = 0;
                            }
                            if (item.x < block.x) {
                                item.velocityX = -item.velocityX;
                            }
                        }
                    });
                    
                    // Remove off-screen items
                    if (item.x < this.camera.x - 100 || item.x > this.camera.x + this.canvas.width + 100) {
                        this.items.splice(index, 1);
                    }
                });
            }
            
            checkItemCollisions() {
                this.items.forEach((item, index) => {
                    if (this.checkCollision(this.mario, item)) {
                        if (item.type === 'mushroom') {
                            if (this.mario.state === 'small') {
                                this.mario.state = 'big';
                                this.mario.height = 48;
                                this.score += 1000;
                            }
                        } else if (item.type === 'fireflower') {
                            this.mario.state = 'fire';
                            this.mario.height = 48;
                            this.mario.canFire = true;
                            this.score += 1000;
                        } else if (item.type === 'star') {
                            this.mario.invincible = true;
                            this.mario.invincibleTime = 10000;
                            this.score += 1000;
                        }
                        
                        this.items.splice(index, 1);
                        this.createParticles(item.x + 16, item.y + 16, 15, '#00FF00');
                        this.updateHUD();
                    }
                });
            }
            
            updateEnemies(dt) {
                this.enemies.forEach((enemy, index) => {
                    if (!enemy.alive) return;
                    
                    enemy.velocityY += this.mario.gravity;
                    enemy.x += enemy.velocityX;
                    enemy.y += enemy.velocityY;
                    
                    // Ground collision
                    if (enemy.y + enemy.height >= this.groundLevel) {
                        enemy.y = this.groundLevel - enemy.height;
                        enemy.velocityY = 0;
                    }
                    
                    // Block collision
                    this.blocks.forEach(block => {
                        if (this.checkCollision(enemy, block)) {
                            if (enemy.x < block.x) {
                                enemy.velocityX = -Math.abs(enemy.velocityX);
                            } else {
                                enemy.velocityX = Math.abs(enemy.velocityX);
                            }
                        }
                    });
                    
                    // Enemy collision with each other
                    this.enemies.forEach(other => {
                        if (enemy !== other && this.checkCollision(enemy, other)) {
                            enemy.velocityX = -enemy.velocityX;
                        }
                    });
                    
                    // Remove stunned enemies after delay
                    if (enemy.stunned) {
                        setTimeout(() => {
                            this.enemies.splice(index, 1);
                        }, 500);
                    }
                });
            }
            
            checkEnemyCollisions() {
                this.enemies.forEach((enemy, index) => {
                    if (!enemy.alive || enemy.stunned) return;
                    
                    if (this.checkCollision(this.mario, enemy)) {
                        if (this.mario.velocityY > 0 && this.mario.y < enemy.y) {
                            // Jump on enemy
                            enemy.stunned = true;
                            enemy.alive = false;
                            this.mario.velocityY = -10;
                            this.score += 100;
                            this.enemiesKilled++;
                            this.createParticles(enemy.x + 16, enemy.y + 16, 10, '#FF0000');
                            this.updateHUD();
                        } else if (!this.mario.invincible) {
                            // Hit by enemy
                            this.hitByEnemy();
                        } else {
                            // Invincible - kill enemy
                            this.enemies.splice(index, 1);
                            this.score += 100;
                            this.enemiesKilled++;
                            this.createParticles(enemy.x + 16, enemy.y + 16, 10, '#00FFFF');
                        }
                    }
                });
            }
            
            hitByEnemy() {
                if (this.mario.state === 'fire' || this.mario.state === 'big') {
                    this.mario.state = 'small';
                    this.mario.height = 32;
                    this.mario.canFire = false;
                    this.mario.invincible = true;
                    this.mario.invincibleTime = 2000;
                } else {
                    this.loseLife();
                }
            }
            
            loseLife() {
                this.lives--;
                this.updateHUD();
                
                if (this.lives <= 0) {
                    this.gameOver();
                } else {
                    // Respawn
                    this.mario.x = 100;
                    this.mario.y = 500;
                    this.mario.velocityX = 0;
                    this.mario.velocityY = 0;
                    this.mario.state = 'small';
                    this.mario.height = 32;
                    this.mario.invincible = true;
                    this.mario.invincibleTime = 3000;
                    this.camera.x = 0;
                }
            }
            
            shootFireball() {
                const fireball = {
                    x: this.mario.direction === 'right' ? this.mario.x + this.mario.width : this.mario.x - 20,
                    y: this.mario.y + 10,
                    width: 20,
                    height: 20,
                    velocityX: this.mario.direction === 'right' ? 8 : -8,
                    velocityY: -5,
                    gravity: 0.5,
                    bounces: 0,
                    maxBounces: 3
                };
                
                this.fireballs.push(fireball);
                this.createParticles(fireball.x, fireball.y, 5, '#FF4500');
            }
            
            updateFireballs(dt) {
                this.fireballs.forEach((fireball, index) => {
                    fireball.velocityY += fireball.gravity;
                    fireball.x += fireball.velocityX;
                    fireball.y += fireball.velocityY;
                    
                    // Ground bounce
                    if (fireball.y + fireball.height >= this.groundLevel) {
                        fireball.y = this.groundLevel - fireball.height;
                        fireball.velocityY = -8;
                        fireball.bounces++;
                    }
                    
                    // Block collision
                    this.blocks.forEach(block => {
                        if (this.checkCollision(fireball, block)) {
                            fireball.velocityY = -8;
                            fireball.bounces++;
                        }
                    });
                    
                    // Enemy collision
                    this.enemies.forEach((enemy, enemyIndex) => {
                        if (enemy.alive && this.checkCollision(fireball, enemy)) {
                            this.enemies.splice(enemyIndex, 1);
                            this.score += 200;
                            this.enemiesKilled++;
                            this.createParticles(enemy.x + 16, enemy.y + 16, 15, '#FF4500');
                            this.fireballs.splice(index, 1);
                        }
                    });
                    
                    // Remove after max bounces or off-screen
                    if (fireball.bounces >= fireball.maxBounces || 
                        fireball.x < this.camera.x - 100 || 
                        fireball.x > this.camera.x + this.canvas.width + 100) {
                        this.fireballs.splice(index, 1);
                    }
                });
            }
            
            checkCoinCollisions() {
                this.coins_world.forEach(coin => {
                    if (!coin.collected && this.checkCollision(this.mario, coin)) {
                        coin.collected = true;
                        this.collectCoin();
                        this.createParticles(coin.x + 15, coin.y + 15, 10, '#FFD700');
                    }
                });
            }
            
            collectCoin() {
                this.coins++;
                this.score += 200;
                
                if (this.coins >= 100) {
                    this.coins = 0;
                    this.lives++;
                    this.showAchievement('üçÑ Extra Life!');
                }
                
                this.updateHUD();
            }
            
            checkFlagPole() {
                if (this.mario.x + this.mario.width >= this.flagPole.x) {
                    this.levelComplete();
                }
            }
            
            levelComplete() {
                this.gameState = 'levelComplete';
                clearInterval(this.timerInterval);
                
                const timeBonus = this.time * 50;
                const finalScore = this.score + timeBonus;
                
                // Calculate stars
                let stars = 1;
                if (this.enemiesKilled >= 5) stars = 2;
                if (this.time > 200 && this.coins >= 50) stars = 3;
                
                document.getElementById('finalScore').textContent = finalScore;
                document.getElementById('finalCoins').textContent = this.coins;
                document.getElementById('timeBonus').textContent = timeBonus;
                document.getElementById('enemiesKilled').textContent = this.enemiesKilled;
                
                let starsText = '';
                for (let i = 0; i < stars; i++) starsText += '‚≠ê';
                document.getElementById('starsEarned').textContent = starsText;
                
                document.getElementById('levelComplete').style.display = 'block';
            }
            
            nextLevel() {
                this.currentLevel++;
                document.getElementById('levelComplete').style.display = 'none';
                this.startGame();
            }
            
            checkCollision(obj1, obj2) {
                return obj1.x < obj2.x + obj2.width &&
                       obj1.x + obj1.width > obj2.x &&
                       obj1.y < obj2.y + obj2.height &&
                       obj1.y + obj1.height > obj2.y;
            }
            
            createParticles(x, y, count, color = '#FFFFFF') {
                for (let i = 0; i < count; i++) {
                    this.particles.push({
                        x: x,
                        y: y,
                        vx: (Math.random() - 0.5) * 5,
                        vy: (Math.random() - 0.5) * 5 - 2,
                        life: 500,
                        color: color,
                        size: 3 + Math.random() * 4
                    });
                }
            }
            
            updateParticles(dt) {
                this.particles.forEach((p, index) => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.2;
                    p.life -= dt;
                    
                    if (p.life <= 0) {
                        this.particles.splice(index, 1);
                    }
                });
            }
            
            render() {
                // Clear canvas
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Sky gradient
                const gradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height);
                gradient.addColorStop(0, '#5C94FC');
                gradient.addColorStop(1, '#94B8FF');
                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Clouds
                for (let i = 0; i < 5; i++) {
                    const cloudX = (i * 300 + this.animationFrame * 0.2) % (this.levelWidth + 200) - this.camera.x;
                    this.drawCloud(cloudX, 100 + i * 50);
                }
                
                // Save context
                this.ctx.save();
                this.ctx.translate(-this.camera.x, 0);
                
                // Draw blocks
                this.blocks.forEach(block => {
                    this.drawBlock(block);
                });
                
                // Draw pipes
                this.pipes.forEach(pipe => {
                    this.drawPipe(pipe);
                });
                
                // Draw coins
                this.coins_world.forEach(coin => {
                    if (!coin.collected) {
                        coin.rotation += 5;
                        this.drawCoin(coin);
                    }
                });
                
                // Draw items
                this.items.forEach(item => {
                    this.drawItem(item);
                });
                
                // Draw enemies
                this.enemies.forEach(enemy => {
                    if (enemy.alive && !enemy.stunned) {
                        this.drawEnemy(enemy);
                    }
                });
                
                // Draw fireballs
                this.fireballs.forEach(fireball => {
                    this.drawFireball(fireball);
                });
                
                // Draw particles
                this.particles.forEach(p => {
                    this.ctx.fillStyle = p.color;
                    this.ctx.globalAlpha = p.life / 500;
                    this.ctx.fillRect(p.x, p.y, p.size, p.size);
                    this.ctx.globalAlpha = 1;
                });
                
                // Draw Mario
                this.drawMario();
                
                // Draw flag pole
                this.drawFlagPole();
                
                // Restore context
                this.ctx.restore();
                
                // Draw ground
                this.ctx.fillStyle = '#C84C0C';
                this.ctx.fillRect(0, this.groundLevel, this.canvas.width, this.canvas.height - this.groundLevel);
            }
            
            drawMario() {
                this.ctx.save();
                
                // Invincibility flicker
                if (this.mario.invincible && Math.floor(this.animationFrame / 5) % 2 === 0) {
                    this.ctx.globalAlpha = 0.5;
                }
                
                // Draw Mario based on state
                const colors = {
                    small: '#FF0000',
                    big: '#FF0000',
                    fire: '#FF4500'
                };
                
                this.ctx.fillStyle = colors[this.mario.state];
                this.ctx.fillRect(this.mario.x, this.mario.y, this.mario.width, this.mario.height);
                
                // Face
                this.ctx.fillStyle = '#FFE4C4';
                this.ctx.fillRect(this.mario.x + 8, this.mario.y + 8, 16, 16);
                
                // Eyes
                this.ctx.fillStyle = '#000';
                if (this.mario.direction === 'right') {
                    this.ctx.fillRect(this.mario.x + 16, this.mario.y + 12, 4, 4);
                } else {
                    this.ctx.fillRect(this.mario.x + 12, this.mario.y + 12, 4, 4);
                }
                
                // Mustache
                this.ctx.fillRect(this.mario.x + 10, this.mario.y + 18, 12, 4);
                
                this.ctx.restore();
            }
            
            drawBlock(block) {
                if (block.type === 'ground') {
                    this.ctx.fillStyle = '#8B4513';
                    this.ctx.fillRect(block.x, block.y, block.width, block.height);
                    this.ctx.strokeStyle = '#654321';
                    this.ctx.strokeRect(block.x, block.y, block.width, block.height);
                } else if (block.type === 'question') {
                    this.ctx.fillStyle = '#FFD700';
                    this.ctx.fillRect(block.x, block.y, block.width, block.height);
                    this.ctx.strokeStyle = '#FFA500';
                    this.ctx.lineWidth = 2;
                    this.ctx.strokeRect(block.x, block.y, block.width, block.height);
                    
                    // Question mark
                    this.ctx.fillStyle = '#FFF';
                    this.ctx.font = 'bold 24px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.textBaseline = 'middle';
                    this.ctx.fillText('?', block.x + 20, block.y + 20);
                } else if (block.type === 'brick') {
                    this.ctx.fillStyle = '#CD853F';
                    this.ctx.fillRect(block.x, block.y, block.width, block.height);
                    
                    // Brick pattern
                    this.ctx.strokeStyle = '#8B4513';
                    for (let i = 0; i < 4; i++) {
                        this.ctx.strokeRect(block.x, block.y + i * 10, block.width, 10);
                    }
                } else if (block.type === 'platform') {
                    this.ctx.fillStyle = '#228B22';
                    this.ctx.fillRect(block.x, block.y, block.width, block.height);
                } else if (block.type === 'used') {
                    this.ctx.fillStyle = '#8B7355';
                    this.ctx.fillRect(block.x, block.y, block.width, block.height);
                }
            }
            
            drawPipe(pipe) {
                // Pipe body
                this.ctx.fillStyle = '#00AA00';
                this.ctx.fillRect(pipe.x, pipe.y, pipe.width, pipe.height);
                
                // Pipe rim
                this.ctx.fillStyle = '#00CC00';
                this.ctx.fillRect(pipe.x - 10, pipe.y, pipe.width + 20, 20);
                
                // Highlights
                this.ctx.fillStyle = '#00FF00';
                this.ctx.fillRect(pipe.x + 10, pipe.y + 5, 10, pipe.height - 5);
            }
            
            drawCoin(coin) {
                this.ctx.save();
                this.ctx.translate(coin.x + 15, coin.y + 15);
                this.ctx.rotate(coin.rotation * Math.PI / 180);
                
                this.ctx.fillStyle = '#FFD700';
                this.ctx.beginPath();
                this.ctx.arc(0, 0, 15, 0, Math.PI * 2);
                this.ctx.fill();
                
                this.ctx.fillStyle = '#FFA500';
                this.ctx.font = 'bold 16px Arial';
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                this.ctx.fillText('$', 0, 0);
                
                this.ctx.restore();
            }
            
            drawItem(item) {
                const icons = {
                    mushroom: 'üçÑ',
                    fireflower: 'üå∫',
                    star: '‚≠ê'
                };
                
                this.ctx.font = '32px Arial';
                this.ctx.fillText(icons[item.type] || '?', item.x, item.y + 32);
            }
            
            drawEnemy(enemy) {
                const icons = {
                    goomba: 'ü¶ä',
                    koopa: 'üê¢'
                };
                
                this.ctx.font = '32px Arial';
                this.ctx.fillText(icons[enemy.type], enemy.x, enemy.y + 32);
            }
            
            drawFireball(fireball) {
                this.ctx.fillStyle = '#FF4500';
                this.ctx.beginPath();
                this.ctx.arc(fireball.x + 10, fireball.y + 10, 10, 0, Math.PI * 2);
                this.ctx.fill();
                
                // Flame effect
                this.ctx.fillStyle = '#FFD700';
                this.ctx.beginPath();
                this.ctx.arc(fireball.x + 10, fireball.y + 10, 6, 0, Math.PI * 2);
                this.ctx.fill();
            }
            
            drawFlagPole() {
                // Pole
                this.ctx.fillStyle = '#FFFFFF';
                this.ctx.fillRect(this.flagPole.x, this.flagPole.y, this.flagPole.width, this.flagPole.height);
                
                // Flag
                this.ctx.fillStyle = '#FF0000';
                this.ctx.beginPath();
                this.ctx.moveTo(this.flagPole.x + this.flagPole.width, this.flagPole.y);
                this.ctx.lineTo(this.flagPole.x + this.flagPole.width + 60, this.flagPole.y + 20);
                this.ctx.lineTo(this.flagPole.x + this.flagPole.width, this.flagPole.y + 40);
                this.ctx.fill();
            }
            
            drawCloud(x, y) {
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                this.ctx.beginPath();
                this.ctx.arc(x, y, 30, 0, Math.PI * 2);
                this.ctx.arc(x + 25, y, 35, 0, Math.PI * 2);
                this.ctx.arc(x + 50, y, 30, 0, Math.PI * 2);
                this.ctx.fill();
            }
            
            updateHUD() {
                document.getElementById('scoreDisplay').textContent = 
                    String(this.score).padStart(6, '0');
                document.getElementById('coinsDisplay').textContent = '√ó ' + this.coins;
                document.getElementById('worldDisplay').textContent = 
                    this.currentWorld + '-' + this.currentLevel;
                document.getElementById('timeDisplay').textContent = this.time;
                document.getElementById('livesCount').textContent = this.lives;
                
                // Power-up status
                document.getElementById('mushroomStatus').textContent = 
                    this.mario.state !== 'small' ? 'Active' : 'Ready';
                document.getElementById('starStatus').textContent = 
                    this.mario.invincible ? 'Active' : 'Ready';
                document.getElementById('fireStatus').textContent = 
                    this.mario.canFire ? 'Active' : 'Ready';
            }
            
            showAchievement(text) {
                const achievement = document.createElement('div');
                achievement.className = 'achievement';
                achievement.textContent = text;
                document.body.appendChild(achievement);
                
                setTimeout(() => achievement.remove(), 3000);
            }
            
            gameOver() {
                this.gameState = 'gameOver';
                alert('GAME OVER!\n\nScore: ' + this.score + '\nCoins: ' + this.coins);
                this.backToMenu();
            }
            
            backToMenu() {
                this.gameState = 'menu';
                document.getElementById('levelComplete').style.display = 'none';
                document.getElementById('menuScreen').classList.remove('hidden');
                clearInterval(this.timerInterval);
            }
            
            showLevelSelect() {
                alert('üó∫Ô∏è LEVEL SELECT\n\nWorld 1-1 to 1-8\nMore levels coming soon!');
            }
            
            showControls() {
                alert(`üéØ CONTROLS

‚Üê ‚Üí : Move Left/Right
Space: Jump
Shift: Run
F: Shoot Fireball (when powered up)

üéÆ POWER-UPS:
üçÑ Mushroom - Grow Big
üå∫ Fire Flower - Shoot Fireballs  
‚≠ê Star - Invincibility

üí° TIPS:
- Jump on enemies to defeat them
- Collect 100 coins for extra life
- Hit ? blocks for power-ups
- Reach the flag to complete level`);
            }
        }
        
        // Initialize game
        const game = new SuperMario();
        window.game = game;
        
        console.log('%cüçÑ SUPER MARIO LOADED! üçÑ', 'color: #FF0000; font-size: 24px; font-weight: bold;');
    </script>
</body>
</html>
